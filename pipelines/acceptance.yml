groups:
- name: all
  jobs:
  - log-cache-bump-submodule
  - metric-store-bump-submodule
  - log-cache-docker-images
  - cf-deploy
  - "ðŸ¥“ Bake and Install Tile ðŸ¥“"
  - log-cache-acceptance-tests-release-bump-submodule
  - lcats
  - cats
  - log-cache-release-elect-promotion
  - log-cache-master-promotion
  - metric-store-release-elect-promotion
  - metric-store-master-promotion
  - create-metric-store-dev-release
- name: log-cache
  jobs:
  - log-cache-bump-submodule
  - cf-deploy
  - log-cache-docker-images
  - log-cache-acceptance-tests-release-bump-submodule
  - lcats
  - cats
  - log-cache-release-elect-promotion
  - log-cache-master-promotion
- name: metric-store
  jobs:
  - metric-store-bump-submodule
  - cf-deploy
  - "ðŸ¥“ Bake and Install Tile ðŸ¥“"
  - metric-store-release-elect-promotion
  - metric-store-master-promotion
- name: log-cache-cli
  jobs:
  - log-cache-cli-tests
  - lcats
  - log-cache-cli-integration-tests
  - log-cache-cli-promotion
- name: leadership-election
  jobs:
  - leadership-election-tests
  - leadership-election-bump-submodule
- name: log-cache-tools
  jobs:
  - log-cache-tools-tests

resource_types:
- name: slack-notification
  type: docker-image
  source:
    repository: cfcommunity/slack-notification-resource
    tag: latest

- name: gcs-resource
  type: docker-image
  source:
    repository: frodenas/gcs-resource

resources:
- name: cf-deployment
  type: git
  source:
    uri: https://github.com/cloudfoundry/cf-deployment
    branch: master

# TODO: this is a PR to cf-d branch. CI will break when it is merged + deleted
# shift over to cf-deployment resource and if merged, the cf-deploy job should not change
- name: cf-deployment-delete-me-when-merged
  type: git
  source:
    uri: https://github.com/cloudfoundry/cf-deployment
    branch: add-system-metrics-agent

- name: cf-deployment-concourse-tasks
  type: git
  source:
    uri: https://github.com/cloudfoundry/cf-deployment-concourse-tasks
    branch: v7.9

- name: cf-deployment-concourse-tasks-image
  type: docker-image
  source:
    repository: relintdockerhubpushbot/cf-deployment-concourse-tasks
    tag: v5.26.0

- name: denver-locks
  type: git
  source:
    uri: git@github.com:pivotal-cf/denver-locks.git
    branch: master
    private_key: ((github-key-ci.yml/Notes/github_key))

- name: log-cache-acceptance-tests
  type: git
  source:
    uri: https://github.com/cloudfoundry/log-cache-acceptance-tests
    branch: master

- name: log-cache-acceptance-tests-release
  type: git
  source:
    uri: git@github.com:cloudfoundry/log-cache-acceptance-tests-release
    branch: master
    private_key: ((github-key-ci.yml/Notes/github_key))

- name: cf-acceptance-tests
  type: git
  source:
    uri: https://github.com/cloudfoundry/cf-acceptance-tests
    branch: master

- name: log-cache-ci
  type: git
  source:
    uri: git@github.com:cloudfoundry/log-cache-ci
    branch: master
    private_key: ((github-key-ci.yml/Notes/github_key))

- name: log-cache-deployments
  type: git
  source:
    uri: git@github.com:cloudfoundry/log-cache-deployments
    branch: master
    private_key: ((github-key-ci.yml/Notes/github_key))

- name: log-cache-ci-docker-images
  type: git
  source:
    uri: git@github.com:cloudfoundry/log-cache-ci
    branch: master
    private_key: ((github-key-ci.yml/Notes/github_key))
    paths:
    - docker-images

- name: log-cache-image
  type: docker-image
  source:
    repository: logcache/log-cache
    username: ((docker-hub-ci.yml/Notes/docker-hub-username))
    password: ((docker-hub-ci.yml/Notes/docker-hub-password))

- name: scheduler-image
  type: docker-image
  source:
    repository: logcache/log-cache-scheduler
    username: ((docker-hub-ci.yml/Notes/docker-hub-username))
    password: ((docker-hub-ci.yml/Notes/docker-hub-password))

- name: nozzle-image
  type: docker-image
  source:
    repository: logcache/log-cache-nozzle
    username: ((docker-hub-ci.yml/Notes/docker-hub-username))
    password: ((docker-hub-ci.yml/Notes/docker-hub-password))

- name: gateway-image
  type: docker-image
  source:
    repository: logcache/log-cache-gateway
    username: ((docker-hub-ci.yml/Notes/docker-hub-username))
    password: ((docker-hub-ci.yml/Notes/docker-hub-password))

- name: pcf-observability-ci-image
  type: docker-image
  source:
    repository: gcr.io/cf-denver/pcf-observability-ci
    username: _json_key
    password: ((release-credentials.yml/Notes/gcp-service-account-key))

- name: log-cache-release
  type: git
  source:
    uri: git@github.com:cloudfoundry/log-cache-release
    branch: develop
    private_key: ((github-key-ci.yml/Notes/github_key))
    ignore_paths:
    - .final_builds
    - releases
    disable_ci_skip: false

- name: log-cache-release-elect
  type: git
  source:
    uri: git@github.com:cloudfoundry/log-cache-release
    branch: release-elect
    private_key: ((github-key-ci.yml/Notes/github_key))

- name: log-cache-release-master
  type: git
  source:
    uri: git@github.com:cloudfoundry/log-cache-release
    branch: master
    private_key: ((github-key-ci.yml/Notes/github_key))
    disable_ci_skip: true

- name: log-cache
  type: git
  source:
    uri: git@github.com:cloudfoundry/log-cache
    branch: master
    private_key: ((github-key-ci.yml/Notes/github_key))

- name: metric-store
  type: git
  source:
    uri: git@github.com:pivotal/metric-store
    branch: master
    private_key: ((github-key-ci.yml/Notes/github_key))

- name: metric-store-release
  type: git
  source:
    uri: git@github.com:pivotal/metric-store-release
    branch: develop
    private_key: ((github-key-ci.yml/Notes/github_key))
    ignore_paths:
    - .final_builds
    - releases
    disable_ci_skip: false

- name: metric-store-release-elect
  type: git
  source:
    uri: git@github.com:pivotal/metric-store-release
    branch: release-elect
    private_key: ((github-key-ci.yml/Notes/github_key))

- name: metric-store-release-master
  type: git
  source:
    uri: git@github.com:pivotal/metric-store-release
    branch: master
    private_key: ((github-key-ci.yml/Notes/github_key))
    disable_ci_skip: true

- name: log-cache-cli
  type: git
  source:
    uri: https://github.com/cloudfoundry/log-cache-cli
    branch: develop

- name: log-cache-tools
  type: git
  source:
    uri: https://github.com/cloudfoundry-incubator/log-cache-tools
    branch: master

- name: log-cache-cli-master
  type: git
  source:
    uri: git@github.com:cloudfoundry/log-cache-cli
    branch: master
    private_key: ((github-key-ci.yml/Notes/github_key))

- name: bumper-tool
  type: git
  source:
    uri: https://github.com/loggregator/bumper

- name: leadership-election
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/leadership-election

- name: leadership-election-release
  type: git
  source:
    branch: develop
    ignore_paths:
    - .final_builds
    - releases
    private_key: ((github-key-ci.yml/Notes/github_key))
    uri: git@github.com:cloudfoundry/leadership-election-release

- name: metric-registrar-release
  type: github-release
  source:
    user: pivotal-cf
    repository: metric-registrar-release
    access_token: ((github-key-ci.yml/Notes/github-access-token))

- name: grafana-boshrelease
  type: git
  source:
    uri: https://github.com/vito/grafana-boshrelease

- name: concourse-tasks
  type: git
  source:
    uri: https://github.com/pivotal-cf/concourse-tasks
    branch: master

- name: bobble
  type: git
  source:
    uri: git@github.com:pivotal/bobble
    branch: master
    private_key: ((github-key-ci.yml/Notes/github_key))

- name: slack-alert
  type: slack-notification
  source:
    url: ((slack-ci.yml/Notes/slack_alert_webhook_url))

- name: slack-high-visibility-alert
  type: slack-notification
  source:
    url: ((slack-ci.yml/Notes/slack_high_visibility_alert_webhook_url))

- name: notification-log-cache-tests-version
  type: semver
  source:
    driver: gcs
    bucket: log-cache-ci-notifications
    key: log-cache-slack-log-cache-tests-version
    initial_version: 0.0.0
    json_key: ((release-credentials.yml/Notes/gcp-service-account-key))

- name: notification-cli-tests-version
  type: semver
  source:
    driver: gcs
    bucket: log-cache-ci-notifications
    key: log-cache-slack-cli-tests-version
    initial_version: 0.0.0
    json_key: ((release-credentials.yml/Notes/gcp-service-account-key))

- name: notification-tools-tests-version
  type: semver
  source:
    driver: gcs
    bucket: log-cache-ci-notifications
    key: log-cache-slack-tools-tests-version
    initial_version: 0.0.0
    json_key: ((release-credentials.yml/Notes/gcp-service-account-key))

- name: notification-cli-integration-tests-version
  type: semver
  source:
    driver: gcs
    bucket: log-cache-ci-notifications
    key: log-cache-slack-integration-tests-version
    initial_version: 0.0.0
    json_key: ((release-credentials.yml/Notes/gcp-service-account-key))

- name: notification-cf-deploy-version
  type: semver
  source:
    driver: gcs
    bucket: log-cache-ci-notifications
    key: log-cache-slack-cf-deploy-version
    initial_version: 0.0.0
    json_key: ((release-credentials.yml/Notes/gcp-service-account-key))

- name: metric-store-dev-release-version
  type: semver
  source:
    driver: gcs
    bucket: log-cache-ci-notifications
    key: metric-store-dev-release-version
    initial_version: 0.0.0
    json_key: ((release-credentials.yml/Notes/gcp-service-account-key))

- name: p-metric-store-version
  type: semver
  source:
    driver: gcs
    bucket: log-cache-ci-versions
    key: metric-store-release-acceptance-tile
    json_key: ((release-credentials.yml/Notes/gcp-service-account-key))
    initial_version: 0.0.0

- name: metric-store-dev-release
  type: gcs-resource
  source:
    bucket: log-cache-ci-notifications
    json_key: ((release-credentials.yml/Notes/gcp-service-account-key))
    regexp: metric-store-dev-releases/release-(.*).tgz

jobs:
###############################################################################
# LOG CACHE
###############################################################################
- name: log-cache-cli-tests
  serial: true
  public: true
  plan:
  - aggregate:
    - get: cf-deployment-concourse-tasks
    - get: log-cache-ci
    - get: log-cache-cli
      trigger: true
    - get: notification-cli-tests-version
      params: { bump: patch }
  - task: create-slack-message
    file: log-cache-ci/tasks/alert-message-create/task.yml
    input_mapping: { slack-rate-limit-version: notification-cli-tests-version }
    params:
      TITLE: Log Cache CLI Tests
  - task: run-tests
    file: log-cache-ci/tasks/go-test-module/task.yml
    input_mapping:
      source-repo: log-cache-cli
  on_failure:
    do:
    - put: notification-cli-tests-version
      params: { file: notification-cli-tests-version/version }
    - task: enable-disable-alert-failure
      file: log-cache-ci/tasks/enable-disable-alert-failure/task.yml
      input_mapping: { slack-rate-limit-version: notification-cli-tests-version }
      params: { alert_multiple: 5 }
    - put: slack-alert
      params:
        silent: true
        username: ((slack-ci.yml/Notes/slack_alert_username))
        icon_url: ((slack-ci.yml/Notes/slack_alert_icon_url))
        channel: ((slack-ci.yml/Notes/slack_alert_channel))
        text_file: modified-metadata/alert_toggle
        attachments_file: modified-metadata/alert_message_failure
  on_success:
    do:
    - task: enable-disable-alert-success
      file: log-cache-ci/tasks/enable-disable-alert-success/task.yml
      input_mapping: { slack-rate-limit-version: notification-cli-tests-version }
    - put: slack-alert
      params:
        silent: true
        username: ((slack-ci.yml/Notes/slack_alert_username))
        icon_url: ((slack-ci.yml/Notes/slack_alert_icon_url))
        channel: ((slack-ci.yml/Notes/slack_alert_channel))
        text_file: modified-metadata/alert_toggle
        attachments_file: modified-metadata/alert_message_success
    - put: notification-cli-tests-version
      params: { bump: minor }

- name: log-cache-docker-images
  serial: true
  public: true
  plan:
  - aggregate:
    - get: log-cache-ci
    - get: log-cache-ci-docker-images
      trigger: true
    - get: log-cache-release
      trigger: true
      passed: ["log-cache-bump-submodule"]
  - aggregate:
    - task: build-log-cache-image
      file: log-cache-ci/tasks/build-go-docker-image/task.yml
      input_mapping:
        context-repo: log-cache-ci-docker-images
        source-repo: log-cache-release
      output_mapping:
        build-image: build-log-cache-image
      params:
        CONTEXT_PATH: docker-images/log-cache
        BASE_PACKAGE: code.cloudfoundry.org/log-cache
    - task: build-nozzle-image
      file: log-cache-ci/tasks/build-go-docker-image/task.yml
      input_mapping:
        context-repo: log-cache-ci-docker-images
        source-repo: log-cache-release
      output_mapping:
        build-image: build-nozzle-image
      params:
        CONTEXT_PATH: docker-images/log-cache-nozzle
        BASE_PACKAGE: code.cloudfoundry.org/log-cache
    - task: build-gateway-image
      file: log-cache-ci/tasks/build-go-docker-image/task.yml
      input_mapping:
        context-repo: log-cache-ci-docker-images
        source-repo: log-cache-release
      output_mapping:
        build-image: build-gateway-image
      params:
        CONTEXT_PATH: docker-images/log-cache-gateway
        BASE_PACKAGE: code.cloudfoundry.org/log-cache
    - task: build-scheduler-image
      file: log-cache-ci/tasks/build-go-docker-image/task.yml
      input_mapping:
        context-repo: log-cache-ci-docker-images
        source-repo: log-cache-release
      output_mapping:
        build-image: build-scheduler-image
      params:
        CONTEXT_PATH: docker-images/log-cache-scheduler
        BASE_PACKAGE: code.cloudfoundry.org/log-cache
  - aggregate:
    - put: log-cache-image
      params:
        build: build-log-cache-image/build
        tag: build-log-cache-image/tag
        tag_as_latest: true
        cache: true
        cache_tag: latest
    - put: nozzle-image
      params:
        build: build-nozzle-image/build
        tag: build-nozzle-image/tag
        tag_as_latest: true
        cache: true
        cache_tag: latest
    - put: gateway-image
      params:
        build: build-gateway-image/build
        tag: build-gateway-image/tag
        tag_as_latest: true
        cache: true
        cache_tag: latest
    - put: scheduler-image
      params:
        build: build-scheduler-image/build
        tag: build-scheduler-image/tag
        tag_as_latest: true
        cache: true
        cache_tag: latest

- name: log-cache-bump-submodule
  serial: true
  plan:
  - aggregate:
    - get: cf-deployment-concourse-tasks-image
    - get: log-cache-ci
    - get: log-cache-release
      trigger: true
    - get: log-cache
      trigger: true
  - task: update-log-cache-submodule
    file: log-cache-ci/tasks/bump-submodule/task.yml
    input_mapping:
      release-repo: log-cache-release
      source-repo: log-cache
    output_mapping:
      bumped-release-repo: bumped-log-cache-release
    params:
      SUBMODULE_PATH: src/code.cloudfoundry.org/log-cache
  - task: sync-package-specs
    file: log-cache-ci/tasks/run-release-script/task.yml
    input_mapping:
      release-repo: bumped-log-cache-release
    output_mapping:
      updated-release-repo: synced-log-cache-release
    params:
      SCRIPT: scripts/sync-package-specs
  - do:
    - get: notification-log-cache-tests-version
      params: { bump: patch }
    - task: create-slack-message
      file: log-cache-ci/tasks/alert-message-create/task.yml
      input_mapping: { slack-rate-limit-version: notification-log-cache-tests-version }
      params:
        TITLE: Log Cache Bump Submodule
    - task: run-tests
      file: log-cache-ci/tasks/run-release-script/task.yml
      input_mapping:
        release-repo: synced-log-cache-release
      params:
        SCRIPT: scripts/test
  - task: commit
    file: log-cache-ci/tasks/commit-with-shortlog/task.yml
    image: cf-deployment-concourse-tasks-image
    input_mapping:
      release-repo: synced-log-cache-release
    output_mapping:
      committed-repo: committed-log-cache-release
    params:
      PATHS: |
        src/code.cloudfoundry.org/log-cache
        packages
  - put: log-cache-release
    params:
      repository: committed-log-cache-release
      rebase: true
  on_failure:
    do:
    - put: notification-log-cache-tests-version
      params: { file: notification-log-cache-tests-version/version }
    - put: slack-alert
      params:
        silent: true
        username: ((slack-ci.yml/Notes/slack_alert_username))
        icon_url: ((slack-ci.yml/Notes/slack_alert_icon_url))
        channel: ((slack-ci.yml/Notes/slack_alert_channel))
        attachments_file: metadata/alert_message_failure
  on_success:
    do:
    - task: enable-disable-alert-success
      file: log-cache-ci/tasks/enable-disable-alert-success/task.yml
      input_mapping: { slack-rate-limit-version: notification-log-cache-tests-version }
    - put: slack-alert
      params:
        silent: true
        username: ((slack-ci.yml/Notes/slack_alert_username))
        icon_url: ((slack-ci.yml/Notes/slack_alert_icon_url))
        channel: ((slack-ci.yml/Notes/slack_alert_channel))
        text_file: modified-metadata/alert_toggle
        attachments_file: modified-metadata/alert_message_success
    - put: notification-log-cache-tests-version
      params: { bump: minor }

- name: metric-store-bump-submodule
  serial: true
  plan:
  - aggregate:
    - get: cf-deployment-concourse-tasks-image
    - get: log-cache-ci
    - get: metric-store-release
      trigger: true
    - get: metric-store
      trigger: true
  - task: create-slack-message
    file: log-cache-ci/tasks/alert-message-create/task.yml
    params:
      TITLE: Metric Store Bump Submodule
  - task: update-metric-store-submodule
    file: log-cache-ci/tasks/bump-submodule/task.yml
    input_mapping:
      release-repo: metric-store-release
      source-repo: metric-store
    output_mapping:
      bumped-release-repo: bumped-metric-store-release
    params:
      SUBMODULE_PATH: src/github.com/pivotal/metric-store
  - task: sync-package-specs
    file: log-cache-ci/tasks/run-release-script/task.yml
    input_mapping:
      release-repo: bumped-metric-store-release
    output_mapping:
      updated-release-repo: synced-metric-store-release
    params:
      SCRIPT: scripts/sync-package-specs
  - task: run-tests
    file: log-cache-ci/tasks/run-release-script/task.yml
    input_mapping:
      release-repo: synced-metric-store-release
    params:
      SCRIPT: scripts/test
  - task: commit
    file: log-cache-ci/tasks/commit-with-shortlog/task.yml
    image: cf-deployment-concourse-tasks-image
    input_mapping:
      release-repo: synced-metric-store-release
    output_mapping:
      committed-repo: committed-metric-store-release
    params:
      PATHS: |
        src/github.com/pivotal/metric-store
        packages
  - put: metric-store-release
    params:
      repository: committed-metric-store-release
      rebase: true
  on_failure:
    do:
    - put: slack-alert
      params:
        silent: true
        username: ((slack-ci.yml/Notes/slack_alert_username))
        icon_url: ((slack-ci.yml/Notes/slack_alert_icon_url))
        channel: ((slack-ci.yml/Notes/slack_alert_channel))
        attachments_file: metadata/alert_message_failure

- name: log-cache-acceptance-tests-release-bump-submodule
  serial: true
  plan:
  - aggregate:
    - get: cf-deployment-concourse-tasks-image
    - get: log-cache-ci
    - get: log-cache
      trigger: true
    - get: log-cache-acceptance-tests-release
      trigger: true
    - get: log-cache-acceptance-tests
      trigger: true
  - task: create-slack-message
    file: log-cache-ci/tasks/alert-message-create/task.yml
    params:
      TITLE: LCATS Release Bump Submodule
  - task: update-log-cache-submodule
    file: log-cache-ci/tasks/bump-submodule/task.yml
    input_mapping:
      release-repo: log-cache-acceptance-tests-release
      source-repo: log-cache
    output_mapping:
      bumped-release-repo: log-cache-acceptance-tests-release-with-bumped-log-cache
    params:
      SUBMODULE_PATH: src/code.cloudfoundry.org/log-cache
  - task: update-log-cache-acceptance-tests-submodule
    file: log-cache-ci/tasks/bump-submodule/task.yml
    input_mapping:
      release-repo: log-cache-acceptance-tests-release-with-bumped-log-cache
      source-repo: log-cache-acceptance-tests
    output_mapping:
      bumped-release-repo: log-cache-acceptance-tests-release-with-bumped-log-cache-acceptance-tests
    params:
      SUBMODULE_PATH: src/github.com/cloudfoundry/log-cache-acceptance-tests
  - task: sync-package-specs
    file: log-cache-ci/tasks/run-release-script/task.yml
    input_mapping:
      release-repo: log-cache-acceptance-tests-release-with-bumped-log-cache-acceptance-tests
    output_mapping:
      updated-release-repo: synced-log-cache-acceptance-tests-release
    params:
      SCRIPT: scripts/sync-package-specs
  - task: commit
    file: log-cache-ci/tasks/commit-with-shortlog/task.yml
    image: cf-deployment-concourse-tasks-image
    input_mapping:
      release-repo: synced-log-cache-acceptance-tests-release
    output_mapping:
      committed-repo: committed-log-cache-acceptance-tests-release
    params:
      PATHS: |
        src
        packages
  - put: log-cache-acceptance-tests-release
    params:
      repository: committed-log-cache-acceptance-tests-release
      rebase: true
  on_failure:
    do:
    - put: slack-alert
      params:
        silent: true
        username: ((slack-ci.yml/Notes/slack_alert_username))
        icon_url: ((slack-ci.yml/Notes/slack_alert_icon_url))
        channel: ((slack-ci.yml/Notes/slack_alert_channel))
        attachments_file: metadata/alert_message_failure

- name: create-metric-store-dev-release
  plan:
    - aggregate:
      - get: log-cache-ci
      - get: metric-store-release
        trigger: true
        passed: ["metric-store-bump-submodule"]
      - get: metric-store-dev-release-version
        params: { pre: dev }
      - get: cf-deployment-concourse-tasks-image
    - task: create-dev-release
      file: log-cache-ci/tasks/create-dev-release/task.yml
      image: cf-deployment-concourse-tasks-image
      input_mapping:
        bosh-dev-release-dir: metric-store-release
        bosh-dev-release-version: metric-store-dev-release-version
      params:
        JSON_KEY: ((release-credentials.yml/Notes/gcp-service-account-key))
    - put: metric-store-dev-release
      params:
        file: metric-store-dev-release/release-*.tgz
        content_type: application/octet-stream
    - put: metric-store-dev-release-version
      params: { file: bosh-new-dev-release-version/version }

- name: cf-deploy
  serial_groups: [cf-deploy]
  plan:
  - aggregate:
    - get: log-cache-ci
    - get: bbl-state
      resource: denver-locks
    - get: cf-deployment
    - get: cf-deployment-delete-me-when-merged
    - get: cf-deployment-concourse-tasks
    - get: cf-deployment-concourse-tasks-image
    - get: notification-cf-deploy-version
      params: { bump: patch }
  - task: create-slack-message
    file: log-cache-ci/tasks/alert-message-create/task.yml
    input_mapping: { slack-rate-limit-version: notification-cf-deploy-version }
    params:
      TITLE: Log Cache CF Deploy
  - aggregate:
    - do:
      - get: log-cache-release
        trigger: true
        passed: ["log-cache-bump-submodule"]
      - task: upload-log-cache-release
        file: log-cache-ci/tasks/upload-release/task.yml
        image: cf-deployment-concourse-tasks-image
        input_mapping:
          bosh-release-dir: log-cache-release
        params:
          BBL_STATE_DIR: ((bbl_state_dir))
          JSON_KEY: ((release-credentials.yml/Notes/gcp-service-account-key))
    - do:
      - get: metric-store-release
        passed: ["create-metric-store-dev-release"]
      - get: metric-store-dev-release
        trigger: true
        passed: ["create-metric-store-dev-release"]
      - task: upload-metric-store-release
        file: log-cache-ci/tasks/upload-dev-release/task.yml
        image: cf-deployment-concourse-tasks-image
        input_mapping:
          bosh-release-tarball: metric-store-dev-release
        params:
          BBL_STATE_DIR: ((bbl_state_dir))
    - do:
      - get: grafana-boshrelease
      - task: upload-grafana-release
        file: log-cache-ci/tasks/upload-release/task.yml
        image: cf-deployment-concourse-tasks-image
        input_mapping:
          bosh-release-dir: grafana-boshrelease
        params:
          BBL_STATE_DIR: ((bbl_state_dir))
    - do:
      - get: metric-registrar-release
      - task: upload-metric-registrar-release
        file: log-cache-ci/tasks/upload-release-tarball/task.yml
        image: cf-deployment-concourse-tasks-image
        input_mapping:
          release-tarball: metric-registrar-release
        params:
          BBL_STATE_DIR: ((bbl_state_dir))
          RELEASE_TARBALL_GLOB: "release-*"

  - task: copy-ops-files
    image: cf-deployment-concourse-tasks-image
    config:
      platform: linux
      inputs:
      - name: bbl-state
      - name: cf-deployment
      - name: cf-deployment-delete-me-when-merged
      - name: log-cache-ci
      outputs:
      - name: ops-files
      run:
        path: /bin/bash
        args:
        - "-c"
        - |
          set -e

          cp cf-deployment/operations/use-compiled-releases.yml ops-files
          cp cf-deployment/operations/scale-to-one-az.yml ops-files
          cp cf-deployment-delete-me-when-merged/operations/experimental/add-system-metrics-agent.yml ops-files
          cp log-cache-ci/ops-files/grafana-in-cf.yml ops-files
          cp log-cache-ci/ops-files/metric-registrar-in-cf.yml ops-files

          # TODO: delete these ops when cf-d contains them by default
          cat <<EOT >> ops-files/cf-PR-add-log-cache-uptime-metric.yml
          - type: replace
            path: /instance_groups/name=doppler/jobs/name=log-cache-expvar-forwarder/properties/gauges/-
            value:
              name: uptime
              source_id: log-cache
              addr: http://localhost:6060/debug/vars
              template: "{{.LogCache.Uptime}}"
          EOT

          cat <<EOT >> ops-files/cf-PR-log-cache-router-tls.yml
          - type: replace
            path: /instance_groups/name=doppler/jobs/name=log-cache-cf-auth-proxy/properties/external_cert?
            value: "((logcache_ssl.certificate))"
          - type: replace
            path: /instance_groups/name=doppler/jobs/name=log-cache-cf-auth-proxy/properties/external_key?
            value: "((logcache_ssl.private_key))"
          - type: replace
            path: /instance_groups/name=doppler/jobs/name=route_registrar?
            value:
              name: route_registrar
              release: routing
              properties:
                route_registrar:
                  routes:
                  - name: log-cache-reverse-proxy
                    tls_port: 8083
                    registration_interval: 20s
                    server_cert_domain_san: log-cache.((system_domain))
                    uris:
                    - log-cache.((system_domain))
                    - "*.log-cache.((system_domain))"
          - type: replace
            path: /variables/name=logcache_ssl?
            value:
              name: logcache_ssl
              type: certificate
              options:
                ca: service_cf_internal_ca
                common_name: log-cache
                alternative_names:
                - log-cache.((system_domain))
                - "*.log-cache.((system_domain))"
          EOT

          cat <<EOT >> ops-files/test-clients.yml
          - type: replace
            path: /instance_groups/name=uaa/jobs/name=uaa/properties/uaa/clients/lcats?
            value:
              authorities: doppler.firehose
              authorized-grant-types: client_credentials
              scope: doppler.firehose
              secret: ((lcats_client_secret))
          - type: replace
            path: /variables/name=lcats_client_secret?
            value:
              name: lcats_client_secret
              type: password
          - type: replace
            path: /instance_groups/name=uaa/jobs/name=uaa/properties/uaa/clients/blackbox?
            value:
              authorities: doppler.firehose
              authorized-grant-types: client_credentials
              scope: doppler.firehose
              secret: ((blackbox_client_secret))
          - type: replace
            path: /variables/name=blackbox_client_secret?
            value:
              name: blackbox_client_secret
              type: password
          - type: replace
            path: /instance_groups/name=uaa/jobs/name=uaa/properties/uaa/clients/datadog-forwarder?
            value:
              authorities: doppler.firehose
              authorized-grant-types: client_credentials
              scope: doppler.firehose
              secret: ((datadog_forwarder_client_secret))
          - type: replace
            path: /variables/name=datadog_forwarder_client_secret?
            value:
              name: datadog_forwarder_client_secret
              type: password
          EOT

          cat <<EOT >> ops-files/bosh-speed.yml
          - type: replace
            path: /update/max_in_flight
            value: 10
          - type: replace
            path: /update/canaries
            value: 5
          EOT

          cat <<EOT >> ops-files/use-log-cache-latest.yml
          - type: replace
            path: /releases/name=log-cache
            value:
              name: log-cache
              version: latest
          EOT

          cat <<EOT >> ops-files/metric-store.yml
          - type: replace
            path: /releases/-
            value:
              name: metric-store
              version: latest

          - type: replace
            path: /variables/-
            value:
              name: metric_store_ca
              type: certificate
              options:
                common_name: metric-store
                is_ca: true

          - type: replace
            path: /variables/-
            value:
              name: metric_store
              type: certificate
              options:
                ca: metric_store_ca
                common_name: metric-store
                extended_key_usage:
                - client_auth
                - server_auth

          - type: replace
            path: /variables/-
            value:
              name: metricstore_ssl
              type: certificate
              options:
                ca: service_cf_internal_ca
                common_name: metric-store
                alternative_names:
                - metric-store.((system_domain))
                - "*.metric-store.((system_domain))"

          - type: replace
            path: /instance_groups/-
            value:
              name: metric-store
              networks:
              - name: default
              stemcell: default
              vm_type: minimal
              azs:
              - z1
              instances: 3
              persistent_disk_type: 5GB
              jobs:
              - name: metric-store
                release: metric-store
                properties:
                  egress_port: 8080
                  health_addr: localhost:6060
                  tls:
                    ca_cert: ((metric_store.ca))
                    cert: ((metric_store.certificate))
                    key: ((metric_store.private_key))
              - name: metric-store-gateway
                release: metric-store
                properties:
                  gateway_addr: localhost:8081
              - name: metric-store-nozzle
                release: metric-store
                consumes:
                  reverse_log_proxy:
                    from: reverse_log_proxy
                properties:
                  logs_provider:
                    tls:
                      ca_cert: ((logs_provider.ca))
                      cert: ((logs_provider.certificate))
                      key: ((logs_provider.private_key))
              - name: prom_scraper
                release: loggregator-agent
                consumes:
                  loggregator:
                    from: loggregator
                properties:
                  metrics_urls: "http://localhost:6060/metrics,http://localhost:6061/metrics,http://localhost:6065/metrics"
              - name: route_registrar
                release: routing
                properties:
                  route_registrar:
                    routes:
                    - name: metric-store-reverse-proxy
                      port: 8083
                      tls_port: 8083
                      registration_interval: 20s
                      server_cert_domain_san: metric-store.((system_domain))
                      uris:
                      - metric-store.((system_domain))
                      - "*.metric-store.((system_domain))"
              - name: metric-store-cf-auth-proxy
                release: metric-store
                properties:
                  cc:
                    ca_cert: ((service_cf_internal_ca.certificate))
                    common_name: cloud-controller-ng.service.cf.internal
                  proxy_port: 8083
                  external_cert: ((metricstore_ssl.certificate))
                  external_key: ((metricstore_ssl.private_key))
                  uaa:
                    ca_cert: ((uaa_ca.certificate))
                    client_id: doppler
                    client_secret: ((uaa_clients_doppler_secret))
                    internal_addr: https://uaa.service.cf.internal:8443
          EOT

          cat <<EOT >> ops-files/cf-deployment-log-cache-candidate-changes.yml
          - type: replace
            path: /variables/name=logs_provider
            value:
              name: log_cache_to_logs_provider
              type: certificate
              options:
                ca: loggregator_ca
                common_name: log-cache
                extended_key_usage:
                - client_auth
          - type: replace
            path: /variables/name=log_cache_to_loggregator_agent?
            value:
              name: log_cache_to_loggregator_agent
              type: certificate
              options:
                ca: loggregator_ca
                common_name: log-cache
                extended_key_usage:
                - client_auth
          - type: replace
            path: /instance_groups/name=doppler/jobs/name=log-cache-nozzle/properties/logs_provider/tls
            value:
              ca_cert: "((log_cache_to_logs_provider.ca))"
              cert: "((log_cache_to_logs_provider.certificate))"
              key: "((log_cache_to_logs_provider.private_key))"
          - type: replace
            path: /instance_groups/name=doppler/jobs/name=log-cache-expvar-forwarder/properties/loggregator_agent?/tls
            value:
              ca_cert: "((log_cache_to_loggregator_agent.ca))"
              cert: "((log_cache_to_loggregator_agent.certificate))"
              key: "((log_cache_to_loggregator_agent.private_key))"
          - type: replace
            path: /instance_groups/name=scheduler/jobs/name=log-cache-expvar-forwarder/properties/loggregator_agent?/tls
            value:
              ca_cert: "((log_cache_to_loggregator_agent.ca))"
              cert: "((log_cache_to_loggregator_agent.certificate))"
              key: "((log_cache_to_loggregator_agent.private_key))"
          - type: replace
            path: /instance_groups/name=doppler/jobs/name=log-cache-expvar-forwarder/consumes?/loggregator?
            value:
              from: loggregator
          - type: replace
            path: /instance_groups/name=scheduler/jobs/name=log-cache-expvar-forwarder/consumes?/loggregator?
            value:
              from: loggregator
          EOT

          cat <<EOT >> ops-files/cf-deployment-metric-store-candidate-changes.yml
          - type: replace
            path: /instance_groups/name=metric-store/jobs/name=metric-store/provides?
            value:
              metric-store:
                shared: true
          EOT

  - task: upload-stemcell
    file: cf-deployment-concourse-tasks/bosh-upload-stemcell-from-cf-deployment/task.yml
    params:
      BBL_STATE_DIR: ((bbl_state_dir))
  - task: cf-deploy
    file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
    input_mapping:
      vars-files: bbl-state
    params:
      BBL_STATE_DIR: ((bbl_state_dir))
      SYSTEM_DOMAIN: ((sys_domain))
      OPS_FILES: |
        use-compiled-releases.yml
        scale-to-one-az.yml
        test-clients.yml
        bosh-speed.yml
        add-system-metrics-agent.yml
        cf-PR-add-log-cache-uptime-metric.yml
        cf-PR-log-cache-router-tls.yml
        use-log-cache-latest.yml
        metric-store.yml
        grafana-in-cf.yml
        metric-registrar-in-cf.yml
        cf-deployment-log-cache-candidate-changes.yml
        cf-deployment-metric-store-candidate-changes.yml
  - task: enable-feature-flags
    file: cf-deployment-concourse-tasks/set-feature-flags/task.yml
    params:
      BBL_STATE_DIR: ((bbl_state_dir))
      SYSTEM_DOMAIN: ((sys_domain))
      ENABLED_FEATURE_FLAGS: diego_docker
  - task: cleanup
    file: cf-deployment-concourse-tasks/bosh-cleanup/task.yml
    params:
      BBL_STATE_DIR: ((bbl_state_dir))
  - task: create-test-space
    file: log-cache-ci/tasks/create-org-and-space/task.yml
    params:
      BBL_STATE_DIR: ((bbl_state_dir))
      ORG: test
      SPACE: test
      SYSTEM_DOMAIN: ((sys_domain))
  on_failure:
    do:
    - put: notification-cf-deploy-version
      params: { file: notification-cf-deploy-version/version }
    - put: slack-alert
      params:
        silent: true
        username: ((slack-ci.yml/Notes/slack_alert_username))
        icon_url: ((slack-ci.yml/Notes/slack_alert_icon_url))
        channel: ((slack-ci.yml/Notes/slack_alert_channel))
        attachments_file: metadata/alert_message_failure
    - task: enable-disable-alert-failure
      file: log-cache-ci/tasks/enable-disable-alert-failure/task.yml
      input_mapping: { slack-rate-limit-version: notification-cf-deploy-version }
      params: { alert_multiple: 5, ignore_first: true }
    - put: slack-high-visibility-alert
      params:
        silent: true
        username: ((slack-ci.yml/Notes/slack_alert_username))
        icon_url: ((slack-ci.yml/Notes/slack_alert_icon_url))
        channel: ((slack-ci.yml/Notes/slack_high_visibility_alert_channel))
        text_file: modified-metadata/alert_toggle
        attachments_file: modified-metadata/alert_message_failure
  on_success:
    do:
    - task: enable-disable-alert-success
      file: log-cache-ci/tasks/enable-disable-alert-success/task.yml
      input_mapping: { slack-rate-limit-version: notification-cf-deploy-version }
    - put: slack-alert
      params:
        silent: true
        username: ((slack-ci.yml/Notes/slack_alert_username))
        icon_url: ((slack-ci.yml/Notes/slack_alert_icon_url))
        channel: ((slack-ci.yml/Notes/slack_alert_channel))
        text_file: modified-metadata/alert_toggle
        attachments_file: modified-metadata/alert_message_success
    - put: notification-cf-deploy-version
      params: { bump: minor }

- name: "ðŸ¥“ Bake and Install Tile ðŸ¥“"
  plan:
    - aggregate:
      - get: bobble
      - get: concourse-tasks
      - get: log-cache-ci
      - get: log-cache-deployments
      - get: metric-store-release
      - get: p-metric-store-version
        params:
          pre: build
      - get: metric-store-dev-release
        trigger: true
        passed: ["create-metric-store-dev-release"]
      - get: pcf-observability-ci-image
      attempts: 3
    - task: "prepare deployment environment"
      file: bobble/ci-tasks/prepare-environment/prepare-environment.yml
      input_mapping:
        src: log-cache-deployments
      params:
        ENV_PATH: gcp/optimus
    - task: "bake and install"
      image: pcf-observability-ci-image
      file: log-cache-ci/tasks/bake_and_install/task.yml
      input_mapping:
        deployment-tools: bobble
        tile-config: log-cache-ci
        tile-version: p-metric-store-version
      params:
        OPSMAN_USER: ((log-cache-ops-manager/Username))
        OPSMAN_PASSWORD: ((log-cache-ops-manager/Password))
        STEMCELL_URL: https://s3.amazonaws.com/bosh-gce-light-stemcells/light-bosh-stemcell-170.16-google-kvm-ubuntu-xenial-go_agent.tgz
        STEMCELL_SHA: 9bb3663ee35f795f466a65a5fb185c4b650049cd
        PRODUCT_CONFIG_PATH: tile-config/tile/metric-store-config.yml
  ensure:
    put: p-metric-store-version
    params:
      file: p-metric-store-version/version

- name: lcats
  serial_groups: [cf-deploy]
  plan:
  - aggregate:
    - get: log-cache-release
      passed:
      - cf-deploy
      trigger: true
    - get: denver-locks
    - get: log-cache-ci
    - get: cf-deployment-concourse-tasks
    - get: cf-deployment-concourse-tasks-image
    - get: log-cache-acceptance-tests-release
      trigger: true
      passed: ["log-cache-acceptance-tests-release-bump-submodule"]
  - task: create-slack-message
    file: log-cache-ci/tasks/alert-message-create/task.yml
    params:
      TITLE: LCATS
  - task: upload-lcats
    file: log-cache-ci/tasks/upload-release/task.yml
    image: cf-deployment-concourse-tasks-image
    params:
      BBL_STATE_DIR: ((bbl_state_dir))
    input_mapping:
      bbl-state: denver-locks
      bosh-release-dir: log-cache-acceptance-tests-release
  - task: create-ops-files
    image: cf-deployment-concourse-tasks-image
    config:
      platform: linux
      inputs:
      - name: log-cache-ci
      outputs:
      - name: ops-files
      run:
        path: /bin/bash
        args:
        - "-c"
        - |
          set -e
          erb log-cache-ci/ops-files/lcats.yml.erb > ops-files/lcats.yml
    params:
      ENV_NAME: ((env_name))
      SYS_DOMAIN: ((sys_domain))
  - task: lcats-deploy
    file: log-cache-ci/tasks/bosh-deploy/task.yml
    image: cf-deployment-concourse-tasks-image
    params:
      BBL_STATE_DIR: ((bbl_state_dir))
      DEPLOYMENT_NAME: lcats
      MANIFEST_FILE: manifests/manifest.yml
      OPS_FILES: lcats.yml
    input_mapping:
      bbl-state: denver-locks
      bosh-release: log-cache-acceptance-tests-release
      ops-files: ops-files
      vars-files: ops-files
  - task: run-lcats
    file: log-cache-ci/tasks/run-errand/task.yml
    image: cf-deployment-concourse-tasks-image
    params:
      BBL_STATE_DIR: ((bbl_state_dir))
      DEPLOYMENT_NAME: lcats
      ERRAND: lcats
      KEEP_ALIVE: true
    input_mapping:
      bbl-state: denver-locks
  on_failure:
    do:
    - put: slack-alert
      params:
        silent: true
        username: ((slack-ci.yml/Notes/slack_alert_username))
        icon_url: ((slack-ci.yml/Notes/slack_alert_icon_url))
        channel: ((slack-ci.yml/Notes/slack_alert_channel))
        attachments_file: metadata/alert_message_failure

- name: cats
  serial_groups: [cf-deploy]
  plan:
  - aggregate:
    - get: log-cache-release
      passed:
      - cf-deploy
      trigger: true
    - get: denver-locks
    - get: log-cache-ci
    - get: cf-acceptance-tests
      trigger: true
    - get: cf-deployment-concourse-tasks
    - get: cf-deployment-concourse-tasks-image
    - get: bbl-state
      resource: denver-locks
  - task: create-slack-message
    file: log-cache-ci/tasks/alert-message-create/task.yml
    params:
      TITLE: CATS
  - task: integration-config
    file: log-cache-ci/tasks/create-integration-config/task.yml
    image: cf-deployment-concourse-tasks-image
    params:
      BBL_STATE_DIR: ((bbl_state_dir))
      SYSTEM_DOMAIN: ((sys_domain))
  - task: cats
    file: cf-deployment-concourse-tasks/run-cats/task.yml
  on_failure:
    do:
    - put: slack-alert
      params:
        silent: true
        username: ((slack-ci.yml/Notes/slack_alert_username))
        icon_url: ((slack-ci.yml/Notes/slack_alert_icon_url))
        channel: ((slack-ci.yml/Notes/slack_alert_channel))
        attachments_file: metadata/alert_message_failure

- name: log-cache-cli-integration-tests
  serial_groups: [cf-deploy]
  plan:
  - aggregate:
    - get: cf-deployment-concourse-tasks
    - get: cf-deployment-concourse-tasks-image
    - get: log-cache-ci
    - get: log-cache-cli
      passed: [ log-cache-cli-tests ]
      trigger: true
    - get: notification-cli-integration-tests-version
      params: { bump: patch }
    - get: bbl-state
      resource: denver-locks
      passed: [ lcats ]
      trigger: true
  - task: create-slack-message
    file: log-cache-ci/tasks/alert-message-create/task.yml
    input_mapping: { slack-rate-limit-version: notification-cli-integration-tests-version }
    params:
      TITLE: Log Cache CLI Integration Tests
  - task: create-test-space
    file: log-cache-ci/tasks/create-org-and-space/task.yml
    params:
      BBL_STATE_DIR: ((bbl_state_dir))
      ORG: integration-tests
      SPACE: integration-tests
      SYSTEM_DOMAIN: ((sys_domain))
  - task: run-integration-tests
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: logcache/base
      inputs:
        - name: bbl-state
        - name: cf-deployment-concourse-tasks
        - name: log-cache-cli
      params:
        BBL_STATE_DIR: ((bbl_state_dir))
        SYSTEM_DOMAIN: ((sys_domain))
      run:
        path: bash
        args:
          - -c
          - |
            #!/bin/bash
            set -exuo pipefail

            source cf-deployment-concourse-tasks/shared-functions

            setup_bosh_env_vars

            cf api api.${SYSTEM_DOMAIN} --skip-ssl-validation
            (set +x; cf auth admin "$(get_password_from_credhub cf_admin_password)")

            CF_ORG=integration-tests CF_SPACE=integration-tests \
              log-cache-cli/scripts/integration-tests.sh
  on_failure:
    do:
    - put: notification-cli-integration-tests-version
      params: { file: notification-cli-integration-tests-version/version }
    - task: enable-disable-alert-failure
      file: log-cache-ci/tasks/enable-disable-alert-failure/task.yml
      input_mapping: { slack-rate-limit-version: notification-cli-integration-tests-version }
      params: { alert_multiple: 5 }
    - put: slack-alert
      params:
        silent: true
        username: ((slack-ci.yml/Notes/slack_alert_username))
        icon_url: ((slack-ci.yml/Notes/slack_alert_icon_url))
        channel: ((slack-ci.yml/Notes/slack_alert_channel))
        text_file: modified-metadata/alert_toggle
        attachments_file: modified-metadata/alert_message_failure
  on_success:
    do:
    - task: enable-disable-alert-success
      file: log-cache-ci/tasks/enable-disable-alert-success/task.yml
      input_mapping: { slack-rate-limit-version: notification-cli-integration-tests-version }
    - put: slack-alert
      params:
        silent: true
        username: ((slack-ci.yml/Notes/slack_alert_username))
        icon_url: ((slack-ci.yml/Notes/slack_alert_icon_url))
        channel: ((slack-ci.yml/Notes/slack_alert_channel))
        text_file: modified-metadata/alert_toggle
        attachments_file: modified-metadata/alert_message_success
    - put: notification-cli-integration-tests-version
      params: { bump: minor }

- name: log-cache-release-elect-promotion
  serial: true
  plan:
  - aggregate:
    - get: develop
      resource: log-cache-release
      trigger: true
      passed: ["lcats"]
    - get: log-cache-release-elect
  - put: log-cache-release-elect
    params:
      repository: develop

- name: log-cache-cli-promotion
  serial: true
  plan:
  - aggregate:
    - get: log-cache-cli
      passed: [ log-cache-cli-integration-tests ]
      trigger: true
    - get: log-cache-cli-master
    - get: bumper-tool
    - get: log-cache-ci
  - task: bumper
    file: log-cache-ci/tasks/bumper/task.yml
    input_mapping:
      source: log-cache-cli
      dest: log-cache-cli-master
    params:
      SOURCE_BRANCH: develop
      DEST_BRANCH: master
  - put: log-cache-cli-master
    params:
      repository: merged-dest

- name: log-cache-master-promotion
  serial: true
  plan:
  - aggregate:
    - get: log-cache-release-elect
      passed: ["log-cache-release-elect-promotion"]
      trigger: true
    - get: log-cache-release-master
    - get: bumper-tool
    - get: log-cache-ci
  - task: bumper
    file: log-cache-ci/tasks/bumper/task.yml
    input_mapping:
      source: log-cache-release-elect
      dest: log-cache-release-master
    params:
      SOURCE_BRANCH: release-elect
      DEST_BRANCH: master
      FOLLOW_BUMPS_OF: src/code.cloudfoundry.org/log-cache
  - put: log-cache-release-master
    params:
      repository: merged-dest

- name: metric-store-release-elect-promotion
  serial: true
  plan:
  - aggregate:
    - get: develop
      resource: metric-store-release
      trigger: true
      passed: ["cf-deploy", "ðŸ¥“ Bake and Install Tile ðŸ¥“"]
    - get: metric-store-release-elect
  - put: metric-store-release-elect
    params:
      repository: develop

- name: metric-store-master-promotion
  serial: true
  plan:
  - aggregate:
    - get: metric-store-release-elect
      passed: ["metric-store-release-elect-promotion"]
      trigger: true
    - get: metric-store-release-master
    - get: bumper-tool
    - get: log-cache-ci
  - task: bumper
    file: log-cache-ci/tasks/bumper/task.yml
    input_mapping:
      source: metric-store-release-elect
      dest: metric-store-release-master
    params:
      SOURCE_BRANCH: release-elect
      DEST_BRANCH: master
      FOLLOW_BUMPS_OF: src/github.com/pivotal/metric-store
      TRACKER_API_TOKEN: ((tracker-key-ci.yml/Notes/tracker_api_token))
  - put: metric-store-release-master
    params:
      repository: merged-dest

- name: leadership-election-tests
  public: true
  serial: true
  plan:
  - aggregate:
    - get: log-cache-ci
    - get: leadership-election
      trigger: true
  - task: run-tests
    file: log-cache-ci/tasks/go-test-with-latest-packages/task.yml
    params:
      IMPORT_PATH: code.cloudfoundry.org/leadership-election
    input_mapping:
      source-repo: leadership-election

- name: leadership-election-bump-submodule
  serial: true
  plan:
  - aggregate:
    - get: cf-deployment-concourse-tasks-image
    - get: log-cache-ci
    - get: leadership-election-release
      trigger: true
    - get: leadership-election
      passed:
      - leadership-election-tests
      trigger: true
  - task: update-submodule
    file: log-cache-ci/tasks/bump-submodule/task.yml
    params:
      SUBMODULE_PATH: src/code.cloudfoundry.org/leadership-election
    input_mapping:
      release-repo: leadership-election-release
      source-repo: leadership-election
    output_mapping:
      bumped-release-repo: updated-leadership-election-release
  - task: sync-package-specs
    file: log-cache-ci/tasks/run-release-script/task.yml
    params:
      SCRIPT: scripts/sync-package-specs
    input_mapping:
      release-repo: updated-leadership-election-release
    output_mapping:
      updated-release-repo: synced-leadership-election-release
  - task: run-tests
    file: log-cache-ci/tasks/run-release-script/task.yml
    params:
      SCRIPT: scripts/test
    input_mapping:
      release-repo: synced-leadership-election-release
  - task: commit
    file: log-cache-ci/tasks/commit-with-shortlog/task.yml
    image: cf-deployment-concourse-tasks-image
    params:
      PATHS: src/code.cloudfoundry.org/leadership-election packages
    input_mapping:
      release-repo: synced-leadership-election-release
    output_mapping:
      committed-repo: committed-leadership-election-release
  - put: leadership-election-release
    params:
      rebase: true
      repository: committed-leadership-election-release

- name: log-cache-tools-tests
  serial: true
  plan:
  - aggregate:
    - get: log-cache-ci
    - get: log-cache-tools
      trigger: true
    - get: notification-tools-tests-version
      params: { bump: patch }
  - task: create-slack-message
    file: log-cache-ci/tasks/alert-message-create/task.yml
    input_mapping: { slack-rate-limit-version: notification-tools-tests-version }
    params:
      TITLE: Log Cache Tools Tests
  - task: run-tests
    file: log-cache-ci/tasks/go-test-module-with-mod/task.yml
    input_mapping:
      source-repo: log-cache-tools
    params:
      GITHUB_PRIVATE_KEY: ((github-key-ci.yml/Notes/github_key))
      SUB_FOLDERS: |
        lc-datadog-forwarder
        log-cache-emitter
        ms-datadog-forwarder
  on_failure:
    do:
    - put: notification-tools-tests-version
      params: { file: notification-tools-tests-version/version }
    - task: enable-disable-alert-failure
      file: log-cache-ci/tasks/enable-disable-alert-failure/task.yml
      input_mapping: { slack-rate-limit-version: notification-tools-tests-version }
      params: { alert_multiple: 5 }
    - put: slack-alert
      params:
        silent: true
        username: ((slack-ci.yml/Notes/slack_alert_username))
        icon_url: ((slack-ci.yml/Notes/slack_alert_icon_url))
        channel: ((slack-ci.yml/Notes/slack_alert_channel))
        text_file: modified-metadata/alert_toggle
        attachments_file: modified-metadata/alert_message_failure
  on_success:
    do:
    - task: enable-disable-alert-success
      file: log-cache-ci/tasks/enable-disable-alert-success/task.yml
      input_mapping: { slack-rate-limit-version: notification-tools-tests-version }
    - put: slack-alert
      params:
        silent: true
        username: ((slack-ci.yml/Notes/slack_alert_username))
        icon_url: ((slack-ci.yml/Notes/slack_alert_icon_url))
        channel: ((slack-ci.yml/Notes/slack_alert_channel))
        text_file: modified-metadata/alert_toggle
        attachments_file: modified-metadata/alert_message_success
    - put: notification-tools-tests-version
      params: { bump: minor }
