<% envs_we_care_about = { "2.4": "us_2_4", "2.5": "us_2_5", "2.6": "us_2_6" } %>
groups:
- name: all
  jobs:
  - p-metric-store-unit-tests
  - build-docker-images
  - cf-deploy
  - "ü•ñ Bake Tile üç∞"
  - "üöΩ Install Tile üçæ"
  <% envs_we_care_about.each do |name, _| %>
  - "Install on PCF <%= name %>"
  <% end %>
  - build-final-release
  - ü•ñ Bake Final Tile ü•ñ
  - üöÄ Push to Pivnet üöÄ
  - cats
  - p-metric-store-release-elect-promotion
  - p-metric-store-test-gate
  - p-metric-store-master-promotion
  - oss-metric-store-release-elect-promotion
  - oss-metric-store-master-promotion
  - create-p-metric-store-dev-release
  - oss-metric-store-unit-tests
  - oss-ms-üö¨
  - p-ms-üö¨
  - create-oss-metric-store-dev-release
  - bump-oss-metric-store
- name: oss-metric-store
  jobs:
  - oss-metric-store-unit-tests
  - create-oss-metric-store-dev-release
  - cf-deploy
  - cats
  - oss-ms-üö¨
  - oss-metric-store-release-elect-promotion
  - oss-metric-store-master-promotion
- name: p-metric-store
  jobs:
  - p-metric-store-unit-tests
  - p-metric-store-release-elect-promotion
  - p-metric-store-test-gate
  - p-metric-store-master-promotion
  - create-p-metric-store-dev-release
  - cf-deploy
  - p-ms-üö¨
  - "ü•ñ Bake Tile üç∞"
  - "üöΩ Install Tile üçæ"
  <% envs_we_care_about.each do |name, _| %>
  - "Install on PCF <%= name %>"
  <% end %>
  - p-metric-store-release-elect-promotion
  - p-metric-store-master-promotion
  - bump-oss-metric-store
  - build-final-release
  - ü•ñ Bake Final Tile ü•ñ
  - üöÄ Push to Pivnet üöÄ
- name: log-cache-tools
  jobs:
  - log-cache-tools-tests

resource_types:
- name: slack-notification
  type: docker-image
  source:
    repository: cfcommunity/slack-notification-resource
    tag: latest

- name: gcs-resource
  type: docker-image
  source:
    repository: frodenas/gcs-resource

- name: pivnet
  type: docker-image
  source:
    repository: pivotalcf/pivnet-resource
    tag: latest-final

resources:
- name: cf-deployment
  type: git
  source:
    uri: https://github.com/cloudfoundry/cf-deployment
    branch: release-candidate

- name: cf-deployment-concourse-tasks
  type: git
  source:
    uri: https://github.com/cloudfoundry/cf-deployment-concourse-tasks
    branch: v8.12 # bump to latest

- name: cf-deployment-concourse-tasks-image
  type: docker-image
  source:
    repository: relintdockerhubpushbot/cf-deployment-concourse-tasks
    tag: latest

- name: denver-locks
  type: git
  source:
    uri: git@github.com:pivotal-cf/denver-locks.git
    branch: master
    private_key: ((github-key-ci.yml/Notes/github_key))

- name: cf-acceptance-tests
  type: git
  source:
    uri: https://github.com/cloudfoundry/cf-acceptance-tests
    branch: master

- name: metric-store-ci
  type: git
  source:
    uri: git@github.com:cloudfoundry/metric-store-ci
    private_key: ((github-key-ci.yml/Notes/ms_github_private_key))
    branch: master

- name: docker-images
  type: git
  source:
    uri: git@github.com:cloudfoundry/metric-store-ci
    branch: master
    private_key: ((github-key-ci.yml/Notes/ms_github_private_key))
    paths:
    - docker-images

- name: tile-image
  type: docker-image
  source:
    repository: logcache/metric-store-tile
    username: ((docker-hub-ci.yml/Notes/docker-hub-username))
    password: ((docker-hub-ci.yml/Notes/docker-hub-password))

- name: pcf-observability-ci-image
  type: docker-image
  source:
    repository: gcr.io/cf-denver/pcf-observability-ci
    username: _json_key
    password: ((release-credentials.yml/Notes/gcp-service-account-key))

- name: p-metric-store-release
  type: git
  source:
    uri: git@github.com:pivotal/metric-store-release
    branch: develop
    private_key: ((github-key-ci.yml/Notes/ms_github_private_key))
    ignore_paths:
    - .final_builds
    - releases
    disable_ci_skip: false
    clean_tags: true

- name: p-metric-store-github-release
  type: github-release
  source:
    user: pivotal
    repository: metric-store-release
    access_token: ((github-key-ci.yml/Notes/github-access-token))
    drafts: false

- name: p-metric-store-release-elect
  type: git
  source:
    uri: git@github.com:pivotal/metric-store-release
    branch: release-elect
    private_key: ((github-key-ci.yml/Notes/ms_github_private_key))
    clean_tags: true

- name: p-metric-store-release-master
  type: git
  source:
    uri: git@github.com:pivotal/metric-store-release
    branch: master
    private_key: ((github-key-ci.yml/Notes/ms_github_private_key))
    disable_ci_skip: true
    clean_tags: true

- name: oss-metric-store
  type: git
  source:
    uri: git@github.com:cloudfoundry/metric-store-release
    branch: develop
    private_key: ((github-key-ci.yml/Notes/ms_github_private_key))
    ignore_paths:
    - .final_builds
    - releases
    disable_ci_skip: false
    clean_tags: true

- name: oss-metric-store-release-elect
  type: git
  source:
    uri: git@github.com:cloudfoundry/metric-store-release
    branch: release-elect
    private_key: ((github-key-ci.yml/Notes/ms_github_private_key))
    clean_tags: true

- name: oss-metric-store-release-master
  type: git
  source:
    uri: git@github.com:cloudfoundry/metric-store-release
    branch: master
    private_key: ((github-key-ci.yml/Notes/ms_github_private_key))
    disable_ci_skip: true
    clean_tags: true

- name: oss-metric-store-dev-release-version
  type: semver
  source:
    driver: gcs
    bucket: metric-store-ci-notifications
    key: oss-metric-store-dev-release-version
    initial_version: 0.0.0
    json_key: ((release-credentials.yml/Notes/gcp-service-account-key))

- name: oss-metric-store-dev-release
  type: gcs-resource
  source:
    bucket: metric-store-ci-notifications
    json_key: ((release-credentials.yml/Notes/gcp-service-account-key))
    regexp: oss-metric-store-dev-releases/release-(.*).tgz

- name: oss-metric-store-final-bosh-release
  type: gcs-resource
  source:
    bucket: metric-store-ci-notifications
    json_key: ((release-credentials.yml/Notes/gcp-service-account-key))
    regexp: oss-metric-store-final-bosh-releases/release-(.*).tgz

- name: p-metric-store-final-bosh-release
  type: gcs-resource
  source:
    bucket: metric-store-ci-notifications
    json_key: ((release-credentials.yml/Notes/gcp-service-account-key))
    regexp: p-metric-store-final-bosh-releases/release-(.*).tgz

- name: log-cache-tools
  type: git
  source:
    uri: https://github.com/cloudfoundry-incubator/log-cache-tools
    branch: master

- name: bumper-tool
  type: git
  source:
    uri: https://github.com/loggregator/bumper

- name: metric-registrar-release
  type: github-release
  source:
    user: pivotal-cf
    repository: metric-registrar-release
    access_token: ((github-key-ci.yml/Notes/github-access-token))

- name: grafana-boshrelease
  type: git
  source:
    uri: https://github.com/vito/grafana-boshrelease

- name: concourse-tasks
  type: git
  source:
    uri: https://github.com/pivotal-cf/concourse-tasks
    branch: master

- name: golang-release
  type: git
  source:
    uri: git@github.com:bosh-packages/golang-release
    branch: master
    tag_filter: v*
    private_key: ((github-key-ci.yml/Notes/ms_github_private_key))

- name: slack-alert
  type: slack-notification
  source:
    url: ((slack-ci.yml/Notes/slack_alert_webhook_url))

- name: slack-high-visibility-alert
  type: slack-notification
  source:
    url: ((slack-ci.yml/Notes/slack_high_visibility_alert_webhook_url))

- name: notification-tools-tests-version
  type: semver
  source:
    driver: gcs
    bucket: metric-store-ci-notifications
    key: log-cache-slack-tools-tests-version
    initial_version: 0.0.0
    json_key: ((release-credentials.yml/Notes/gcp-service-account-key))

- name: notification-cf-deploy-version
  type: semver
  source:
    driver: gcs
    bucket: metric-store-ci-notifications
    key: log-cache-slack-cf-deploy-version
    initial_version: 0.0.0
    json_key: ((release-credentials.yml/Notes/gcp-service-account-key))

- name: p-metric-store-dev-release-version
  type: semver
  source:
    driver: gcs
    bucket: metric-store-ci-notifications
    key: metric-store-dev-release-version
    initial_version: 0.0.0
    json_key: ((release-credentials.yml/Notes/gcp-service-account-key))

- name: p-metric-store-version
  type: semver
  source:
    driver: gcs
    bucket: metric-store-ci-versions
    key: metric-store-release-acceptance-tile
    json_key: ((release-credentials.yml/Notes/gcp-service-account-key))
    initial_version: 0.2.0-build.24

- name: p-metric-store-dev-release
  type: gcs-resource
  source:
    bucket: metric-store-ci-notifications
    json_key: ((release-credentials.yml/Notes/gcp-service-account-key))
    regexp: metric-store-dev-releases/release-(.*).tgz

- name: temp-baked-tile
  type: gcs-resource
  source:
    bucket: metric-store-ci-notifications
    json_key: ((release-credentials.yml/Notes/gcp-service-account-key))
    regexp: temp-baked-tiles/(.*).pivotal
    initial_version: 0.2.0-build.24

- name: freshly-baked-final-tiles
  type: gcs-resource
  source:
    bucket: p-metric-store-release
    json_key: ((release-credentials.yml/Notes/gcp-service-account-key))
    regexp: tiles/(.*).pivotal

- name: p-metric-store-pivnet-metadata
  type: gcs-resource
  source:
    bucket: p-metric-store-release
    json_key: ((release-credentials.yml/Notes/gcp-service-account-key))
    versioned_file: pivnet/metadata.yml

- name: gcp-light-stemcell
  type: bosh-io-stemcell
  source:
    name: bosh-google-kvm-ubuntu-xenial-go_agent
    version_family: latest
    tarball: true
    preserve_filename: true

- name: p-metric-store-pivnet
  type: pivnet
  source:
    api_token: ((release-credentials.yml/Notes/pivnet-token-metric-store))
    product_slug: p-metric-store

- name: bpm-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/bpm-release

- name: cf-routing-release
  type: bosh-io-release
  source:
    repository: cloudfoundry-incubator/cf-routing-release
    regexp: .*188.*

- name: log-cache-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/log-cache-release

- name: loggregator-agent-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/loggregator-agent-release

- name: hourly-during-the-workday
  type: time
  source:
    location: America/Denver
    interval: 1h
    start: 7:00 AM
    stop: 7:00 PM
    days: [Monday, Tuesday, Wednesday, Thursday, Friday]

jobs:
- name: build-docker-images
  serial: true
  public: true
  plan:
  - get: metric-store-ci
  - get: p-metric-store-release
  - get: docker-images
    trigger: true
  - task: build-metric-store-tile-image
    file: metric-store-ci/tasks/build-go-docker-image/task.yml
    input_mapping:
      context-repo: docker-images
      source-repo: p-metric-store-release
    output_mapping:
      build-image: build-metric-store-tile-image
    params:
      CONTEXT_PATH: docker-images/metric-store-tile
      BASE_PACKAGE: ..
  - put: tile-image
    params:
      build: build-metric-store-tile-image/build
      tag: build-metric-store-tile-image/tag
      tag_as_latest: true
      cache: true
      cache_tag: latest

- name: p-metric-store-unit-tests
  serial: true
  plan:
  - aggregate:
    - get: cf-deployment-concourse-tasks-image
    - get: metric-store-ci
    - get: p-metric-store-release
      trigger: true
  - task: create-slack-message
    file: metric-store-ci/tasks/alert-message-create/task.yml
    params:
      TITLE: Pivotal Metric Store Unit Tests
      TEAM: metric-store-log-cache
  - task: run-tests
    attempts: 3
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: logcache/base
      inputs:
        - name: p-metric-store-release
      run:
        path: bash
        args:
          - -c
          - |
            #!/bin/bash
            set -ex
            pushd p-metric-store-release
              scripts/test unit
            popd
  on_failure:
    do:
    - put: slack-alert
      params:
        silent: true
        username: ((slack-ci.yml/Notes/slack_alert_username))
        icon_url: ((slack-ci.yml/Notes/slack_alert_icon_url))
        channel: ((slack-ci.yml/Notes/slack_alert_channel))
        attachments_file: metadata/alert_message_failure

- name: bump-oss-metric-store
  serial: true
  plan:
  - aggregate:
    - get: metric-store-ci
    - get: p-metric-store-release
      passed: [p-metric-store-unit-tests]
    - get: oss-metric-store
      passed: [oss-metric-store-unit-tests]
      trigger: true
  - task: create-slack-message
    file: metric-store-ci/tasks/alert-message-create/task.yml
    params:
      TITLE: Pivotal Metric Store Bump OSS Metric Store
      TEAM: metric-store-log-cache
  - task: bump-oss-metric-store
    file: metric-store-ci/tasks/bump-oss-metric-store/task.yml
    params:
      GITHUB_PRIVATE_KEY: ((github-key-ci.yml/Notes/ms_github_private_key))
  - put: p-metric-store-release
    params:
      repository: bumped-p-metric-store-release
  - try:
      task: run-tests
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: logcache/base
        inputs:
          - name: bumped-p-metric-store-release
        run:
          path: bash
          args:
            - -c
            - |
              #!/bin/bash
              set -ex
              pushd bumped-p-metric-store-release
                scripts/test unit
              popd
      on_failure:
        do:
        - task: create-tracker-story
          file: metric-store-ci/tasks/create-tracker-story/task.yml
          input_mapping:
            linked-repo: bumped-p-metric-store-release
          params:
            TRACKER_API_TOKEN: ((tracker-key-ci.yml/Notes/tracker_api_token))
            TRACKER_PROJECT_ID: "2205790"
            TRACKER_STORY_TYPE: bug
            TRACKER_STORY_NAME: "Fix p-metric-store-release tests due to OSS Metric Store auto-bump"
            TRACKER_STORY_DESCRIPTION: "The tests are failing due to an OSS Metric Store auto-bump."
            GITHUB_REPO: "pivotal/metric-store-release"
        - put: slack-alert
          params:
            silent: true
            username: ((slack-ci.yml/Notes/slack_alert_username))
            icon_url: ((slack-ci.yml/Notes/slack_alert_icon_url))
            channel: ((slack-ci.yml/Notes/slack_alert_channel))
            attachments_file: metadata/alert_message_failure

- name: create-p-metric-store-dev-release
  serial: true
  plan:
    - aggregate:
      - get: metric-store-ci
      - get: p-metric-store-release
        trigger: true
        passed: ["p-metric-store-unit-tests"]
      - get: p-metric-store-dev-release-version
        params: { pre: dev }
      - get: cf-deployment-concourse-tasks-image
      - get: golang-release
    - task: create-dev-release
      file: metric-store-ci/tasks/create-dev-release/task.yml
      image: cf-deployment-concourse-tasks-image
      input_mapping:
        bosh-dev-release-dir: p-metric-store-release
        bosh-dev-release-version: p-metric-store-dev-release-version
      params:
        JSON_KEY: ((release-credentials.yml/Notes/gcp-service-account-key))
    - put: p-metric-store-dev-release
      params:
        file: metric-store-dev-release/release-*.tgz
        content_type: application/octet-stream
    - put: p-metric-store-dev-release-version
      params: { file: bosh-new-dev-release-version/version }

- name: oss-metric-store-unit-tests
  serial: true
  plan:
  - aggregate:
    - get: cf-deployment-concourse-tasks-image
    - get: metric-store-ci
    - get: oss-metric-store
      trigger: true
  - task: create-slack-message
    file: metric-store-ci/tasks/alert-message-create/task.yml
    params:
      TITLE: OSS Metric Store Unit Tests
      TEAM: metric-store-log-cache
  - task: run-tests
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: logcache/base
      inputs:
        - name: oss-metric-store
      run:
        path: bash
        args:
          - -c
          - |
            #!/bin/bash
            set -ex
            pushd oss-metric-store
              scripts/test unit
            popd
  on_failure:
    do:
    - put: slack-alert
      params:
        silent: true
        username: ((slack-ci.yml/Notes/slack_alert_username))
        icon_url: ((slack-ci.yml/Notes/slack_alert_icon_url))
        channel: ((slack-ci.yml/Notes/slack_alert_channel))
        attachments_file: metadata/alert_message_failure

- name: create-oss-metric-store-dev-release
  serial: true
  plan:
    - aggregate:
      - get: metric-store-ci
      - get: oss-metric-store
        trigger: true
        passed: ["oss-metric-store-unit-tests"]
      - get: oss-metric-store-dev-release-version
        params: { pre: dev }
      - get: cf-deployment-concourse-tasks-image
      - get: golang-release
    - task: create-dev-release
      file: metric-store-ci/tasks/create-dev-release/task.yml
      image: cf-deployment-concourse-tasks-image
      input_mapping:
        bosh-dev-release-dir: oss-metric-store
        bosh-dev-release-version: oss-metric-store-dev-release-version
      params:
        JSON_KEY: ((release-credentials.yml/Notes/gcp-service-account-key))
        OSS_RELEASE: true
    - put: oss-metric-store-dev-release
      params:
        file: metric-store-dev-release/release-*.tgz
        content_type: application/octet-stream
    - put: oss-metric-store-dev-release-version
      params: { file: bosh-new-dev-release-version/version }

- name: cf-deploy
  serial_groups: [cf-deploy]
  plan:
  - aggregate:
    - get: metric-store-ci
    - get: bbl-state
      resource: denver-locks
    - get: cf-deployment
    - get: cf-deployment-concourse-tasks
    - get: cf-deployment-concourse-tasks-image
    - get: notification-cf-deploy-version
      params: { bump: patch }
  - task: create-slack-message
    file: metric-store-ci/tasks/alert-message-create/task.yml
    input_mapping: { slack-rate-limit-version: notification-cf-deploy-version }
    params:
      TITLE: Log Cache CF Deploy
      TEAM: metric-store-log-cache
  - aggregate:
    - do:
      - get: p-metric-store-release
        passed: ["create-p-metric-store-dev-release"]
      - get: p-metric-store-dev-release
        trigger: true
        passed: ["create-p-metric-store-dev-release"]
      - task: upload-p-metric-store-release
        file: metric-store-ci/tasks/upload-dev-release/task.yml
        image: cf-deployment-concourse-tasks-image
        input_mapping:
          bosh-release-tarball: p-metric-store-dev-release
        params:
          BBL_STATE_DIR: ((bbl_state_dir))
    - do:
      - get: oss-metric-store
        passed: ["create-oss-metric-store-dev-release"]
      - get: oss-metric-store-dev-release
        trigger: true
        passed: ["create-oss-metric-store-dev-release"]
      - task: upload-oss-metric-store-release
        file: metric-store-ci/tasks/upload-dev-release/task.yml
        image: cf-deployment-concourse-tasks-image
        input_mapping:
          bosh-release-tarball: oss-metric-store-dev-release
        params:
          BBL_STATE_DIR: ((bbl_state_dir))
    - do:
      - get: grafana-boshrelease
      - task: upload-grafana-release
        file: metric-store-ci/tasks/upload-release/task.yml
        image: cf-deployment-concourse-tasks-image
        input_mapping:
          bosh-release-dir: grafana-boshrelease
        params:
          BBL_STATE_DIR: ((bbl_state_dir))
    - do:
      - get: loggregator-agent-release
      - task: upload-loggregator-agent-release
        file: metric-store-ci/tasks/upload-release-tarball/task.yml
        image: cf-deployment-concourse-tasks-image
        input_mapping:
          release-tarball: loggregator-agent-release
        params:
          BBL_STATE_DIR: ((bbl_state_dir))
          RELEASE_TARBALL_GLOB: "release.*"
    - do:
      - get: metric-registrar-release
      - task: upload-metric-registrar-release
        file: metric-store-ci/tasks/upload-release-tarball/task.yml
        image: cf-deployment-concourse-tasks-image
        input_mapping:
          release-tarball: metric-registrar-release
        params:
          BBL_STATE_DIR: ((bbl_state_dir))
          RELEASE_TARBALL_GLOB: "release-*"
    - do:
      - get: log-cache-release
      - task: upload-log-cache-release
        file: metric-store-ci/tasks/upload-release-tarball/task.yml
        image: cf-deployment-concourse-tasks-image
        input_mapping:
          release-tarball: log-cache-release
        params:
          BBL_STATE_DIR: ((bbl_state_dir))
          RELEASE_TARBALL_GLOB: "release.*"

  - task: copy-ops-files
    image: cf-deployment-concourse-tasks-image
    config:
      platform: linux
      inputs:
      - name: bbl-state
      - name: cf-deployment
      - name: metric-store-ci
      - name: oss-metric-store
      outputs:
      - name: ops-files
      params:
        ENV_NAME: ((env_name))
        SYS_DOMAIN: ((sys_domain))
      run:
        path: /bin/bash
        args:
        - "-c"
        - |
          set -e

          cp cf-deployment/operations/use-compiled-releases.yml ops-files
          cp cf-deployment/operations/scale-to-one-az.yml ops-files
          cp cf-deployment/operations/experimental/add-system-metrics-agent.yml ops-files
          cp cf-deployment/operations/experimental/add-metric-store.yml ops-files
          cp metric-store-ci/ops-files/grafana-in-cf.yml ops-files
          cp metric-store-ci/ops-files/add-grafana-uaa-clients.yml ops-files
          cp metric-store-ci/ops-files/alertmanager-p-metric-store.yml ops-files
          cp metric-store-ci/ops-files/enable-grafana-uaa.yml ops-files
          cp metric-store-ci/ops-files/metric-registrar-in-cf.yml ops-files
          cp metric-store-ci/ops-files/metric-store-in-cf.yml ops-files
          cp metric-store-ci/ops-files/p-metric-store-in-cf.yml ops-files
          cp metric-store-ci/ops-files/awaiting-cf-deployment-prs.yml ops-files
          cp metric-store-ci/ops-files/bosh-speed.yml ops-files
          cp metric-store-ci/ops-files/test-clients.yml ops-files
          cp metric-store-ci/ops-files/use-latest.yml ops-files
          erb metric-store-ci/ops-files/msats.yml.erb > ops-files/msats.yml

  - task: upload-stemcell
    file: cf-deployment-concourse-tasks/bosh-upload-stemcell-from-cf-deployment/task.yml
    params:
      BBL_STATE_DIR: ((bbl_state_dir))
  - task: cf-deploy
    file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
    input_mapping:
      vars-files: bbl-state
    params:
      BBL_STATE_DIR: ((bbl_state_dir))
      SYSTEM_DOMAIN: ((sys_domain))
      OPS_FILES: |
        use-compiled-releases.yml
        scale-to-one-az.yml
        add-system-metrics-agent.yml
        test-clients.yml
        bosh-speed.yml
        add-metric-store.yml
        metric-store-in-cf.yml
        p-metric-store-in-cf.yml
        alertmanager-p-metric-store.yml
        awaiting-cf-deployment-prs.yml
        use-latest.yml
        grafana-in-cf.yml
        add-grafana-uaa-clients.yml
        enable-grafana-uaa.yml
        metric-registrar-in-cf.yml
        msats.yml
  - task: enable-feature-flags
    file: cf-deployment-concourse-tasks/set-feature-flags/task.yml
    params:
      BBL_STATE_DIR: ((bbl_state_dir))
      SYSTEM_DOMAIN: ((sys_domain))
      ENABLED_FEATURE_FLAGS: diego_docker
  - task: cleanup
    file: cf-deployment-concourse-tasks/bosh-cleanup/task.yml
    params:
      BBL_STATE_DIR: ((bbl_state_dir))
  - task: create-test-space
    file: metric-store-ci/tasks/create-org-and-space/task.yml
    params:
      BBL_STATE_DIR: ((bbl_state_dir))
      ORG: test
      SPACE: test
      SYSTEM_DOMAIN: ((sys_domain))
  on_failure:
    do:
    - put: notification-cf-deploy-version
      params: { file: notification-cf-deploy-version/version }
    - put: slack-alert
      params:
        silent: true
        username: ((slack-ci.yml/Notes/slack_alert_username))
        icon_url: ((slack-ci.yml/Notes/slack_alert_icon_url))
        channel: ((slack-ci.yml/Notes/slack_alert_channel))
        attachments_file: metadata/alert_message_failure
    - task: enable-disable-alert-failure
      file: metric-store-ci/tasks/enable-disable-alert-failure/task.yml
      input_mapping: { slack-rate-limit-version: notification-cf-deploy-version }
      params: { alert_multiple: 5, ignore_first: true }
    - put: slack-high-visibility-alert
      params:
        silent: true
        username: ((slack-ci.yml/Notes/slack_alert_username))
        icon_url: ((slack-ci.yml/Notes/slack_alert_icon_url))
        channel: ((slack-ci.yml/Notes/slack_high_visibility_alert_channel))
        text_file: modified-metadata/alert_toggle
        attachments_file: modified-metadata/alert_message_failure
  on_success:
    do:
    - task: enable-disable-alert-success
      file: metric-store-ci/tasks/enable-disable-alert-success/task.yml
      input_mapping: { slack-rate-limit-version: notification-cf-deploy-version }
    - put: slack-alert
      params:
        silent: true
        username: ((slack-ci.yml/Notes/slack_alert_username))
        icon_url: ((slack-ci.yml/Notes/slack_alert_icon_url))
        channel: ((slack-ci.yml/Notes/slack_alert_channel))
        text_file: modified-metadata/alert_toggle
        attachments_file: modified-metadata/alert_message_success
    - put: notification-cf-deploy-version
      params: { bump: minor }

- name: p-ms-üö¨
  serial: true
  plan:
  - aggregate:
    - get: metric-store-ci
    - get: cf-deployment-concourse-tasks-image
    - get: denver-locks
    - get: cf-deployment-concourse-tasks
    - get: p-metric-store-release
      trigger: true
      passed: ["cf-deploy"]
  - task: create-slack-message
    file: metric-store-ci/tasks/alert-message-create/task.yml
    params:
      TITLE: P-Metric-Store Smoke Tests
      TEAM: metric-store-log-cache
  - task: run-msats
    file: metric-store-ci/tasks/run-errand/task.yml
    image: cf-deployment-concourse-tasks-image
    params:
      BBL_STATE_DIR: ((bbl_state_dir))
      DEPLOYMENT_NAME: cf
      ERRAND: metric-store-smoke-tests
      INSTANCE: p-metric-store/0
      KEEP_ALIVE: true
    input_mapping:
      bbl-state: denver-locks
  on_failure:
    do:
    - put: slack-alert
      params:
        silent: true
        username: ((slack-ci.yml/Notes/slack_alert_username))
        icon_url: ((slack-ci.yml/Notes/slack_alert_icon_url))
        channel: ((slack-ci.yml/Notes/slack_alert_channel))
        attachments_file: metadata/alert_message_failure

- name: "ü•ñ Bake Tile üç∞"
  plan:
    - aggregate:
      - get: concourse-tasks
      - get: metric-store-ci
      - get: p-metric-store-release
        passed: ["create-p-metric-store-dev-release"]
      - get: oss-metric-store-dev-release
        passed: ["create-oss-metric-store-dev-release"]
      - get: p-metric-store-version
        params:
          pre: build
      - get: p-metric-store-dev-release
        trigger: true
        passed: ["create-p-metric-store-dev-release"]
      - get: pcf-observability-ci-image
      - get: gcp-light-stemcell
      - get: bpm-release
      - get: cf-routing-release
      - get: loggregator-agent-release
      attempts: 3
    - task: "bake tile"
      image: pcf-observability-ci-image
      file: metric-store-ci/tasks/tile_bake/task.yml
      input_mapping:
        metric-store-release: p-metric-store-release
        metric-store-dev-release: p-metric-store-dev-release
        oss-metric-store-release: oss-metric-store-dev-release
        tile-version: p-metric-store-version
        stemcell: gcp-light-stemcell
    - put: temp-baked-tile
      params:
        file: baked-tile/*.pivotal
        content_type: application/octet-stream
  ensure:
    put: p-metric-store-version
    params:
      file: new-tile-version/version

- name: "üöΩ Install Tile üçæ"
  plan:
    - aggregate:
      - get: concourse-tasks
      - get: metric-store-ci
      - get: p-metric-store-release
        passed: ["ü•ñ Bake Tile üç∞"]
      - get: oss-metric-store-dev-release
        passed: ["ü•ñ Bake Tile üç∞"]
      - get: p-metric-store-dev-release
        passed: ["ü•ñ Bake Tile üç∞"]
      - get: pcf-observability-ci-image
      - get: p-metric-store-version
        passed: ["ü•ñ Bake Tile üç∞"]
      - get: temp-baked-tile
        trigger: true
        passed: ["ü•ñ Bake Tile üç∞"]
      - get: gcp-light-stemcell
        passed: ["ü•ñ Bake Tile üç∞"]
      attempts: 3
    - task: "install tile"
      image: pcf-observability-ci-image
      file: metric-store-ci/tasks/tile_install/task.yml
      input_mapping:
        tile-version: p-metric-store-version
        baked-tile: temp-baked-tile
      params:
        TOOLSMITHS_ENV_JSON: ((ms-pas-acceptance.json/Notes))

<% envs_we_care_about.each do |env_version, pool_name| %>
- name: "Install on PCF <%= env_version %>"
  plan:
  - aggregate:
    - get: concourse-tasks
    - get: metric-store-ci
    - get: p-metric-store-release
      passed: ["ü•ñ Bake Tile üç∞"]
    - get: oss-metric-store-dev-release
      passed: ["ü•ñ Bake Tile üç∞"]
    - get: p-metric-store-dev-release
      passed: ["ü•ñ Bake Tile üç∞"]
    - get: pcf-observability-ci-image
    - get: p-metric-store-version
      passed: ["ü•ñ Bake Tile üç∞"]
    - get: temp-baked-tile
      trigger: true
      passed: ["ü•ñ Bake Tile üç∞"]
    - get: gcp-light-stemcell
      passed: ["ü•ñ Bake Tile üç∞"]
    attempts: 3
  - task: "Claim Smith Env"
    tags: [ cf-denver-shared-vsphere ]
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: logcache/metric-store-tile
      outputs:
      - name: environment
      run:
        path: sh
        args:
        - "-c"
        - |
          set -eu
          # exports smith environment name to `env`
          $(smith claim -p <%= pool_name %> -n "cf-metric-store CI" | tail -1)
          echo "Claimed smith environment: ${env}"
          echo ${env} > environment/name
          smith read > environment/metadata
    attempts: 3
    on_failure:
      task: release-env
      tags: [ cf-denver-shared-vsphere ]
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: logcache/base
        run:
          path: sh
          args:
          - "-c"
          - |
            set -e
            sleep 10
    params:
      TOOLSMITHS_API_TOKEN: ((smith-token-cf-denver/Notes))
  - task: "Upload and Install"
    tags: [ cf-denver-shared-vsphere ]
    input_mapping:
      tile-version: p-metric-store-version
      baked-tile: temp-baked-tile
    image: pcf-observability-ci-image
    file: metric-store-ci/tasks/tile_install/task.yml
    input_mapping:
      tile-version: p-metric-store-version
      baked-tile: temp-baked-tile
    on_success:
      task: release-env
      tags: [ cf-denver-shared-vsphere ]
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: logcache/metric-store-tile
        inputs:
        - name: environment
        run:
          path: sh
          args:
          - "-c"
          - |
            set -e
            smith unclaim -e $(cat environment/name)
      params:
        TOOLSMITHS_API_TOKEN: ((smith-token-cf-denver/Notes))
<% end %>

- name: cats
  serial_groups: [cf-deploy]
  plan:
  - aggregate:
    - get: denver-locks
    - get: oss-metric-store
      trigger: true
      passed: [cf-deploy]
    - get: metric-store-ci
    - get: cf-acceptance-tests
      trigger: true
    - get: cf-deployment-concourse-tasks
    - get: cf-deployment-concourse-tasks-image
    - get: bbl-state
      resource: denver-locks
  - task: create-slack-message
    file: metric-store-ci/tasks/alert-message-create/task.yml
    params:
      TITLE: CATS
      TEAM: metric-store-log-cache
  - task: integration-config
    file: metric-store-ci/tasks/create-integration-config/task.yml
    image: cf-deployment-concourse-tasks-image
    params:
      BBL_STATE_DIR: ((bbl_state_dir))
      SYSTEM_DOMAIN: ((sys_domain))
  - task: cats
    file: cf-deployment-concourse-tasks/run-cats/task.yml
  on_failure:
    do:
    - put: slack-alert
      params:
        silent: true
        username: ((slack-ci.yml/Notes/slack_alert_username))
        icon_url: ((slack-ci.yml/Notes/slack_alert_icon_url))
        channel: ((slack-ci.yml/Notes/slack_alert_channel))
        attachments_file: metadata/alert_message_failure

- name: p-metric-store-test-gate
  serial: true
  plan:
    - aggregate:
      - get: gcp-light-stemcell
        passed: ["ü•ñ Bake Tile üç∞"]
      - get: bpm-release
        passed: ["ü•ñ Bake Tile üç∞"]
      - get: cf-routing-release
        passed: ["ü•ñ Bake Tile üç∞"]
      - get: loggregator-agent-release
        passed: ["ü•ñ Bake Tile üç∞"]
      - get: develop
        resource: p-metric-store-release
        trigger: true
        passed:
          - "p-ms-üö¨"
          <% envs_we_care_about.each do |name, _| %>
          - "Install on PCF <%= name %>"
          <% end %>

- name: p-metric-store-release-elect-promotion
  serial: true
  plan:
  - aggregate:
    - get: p-metric-store-release
      trigger: true
      passed:
        - p-metric-store-test-gate
    - get: p-metric-store-release-elect
    - get: oss-metric-store-release-master
    - get: metric-store-ci
  - task: bump
    file: metric-store-ci/tasks/pre-bumper/task.yml
  - put: p-metric-store-release-elect
    params:
      repository: bumped-p-metric-store-release-elect

- name: p-metric-store-master-promotion
  serial: true
  plan:
  - aggregate:
    - get: hourly-during-the-workday
      trigger: true
    - get: p-metric-store-release
      passed: ["p-metric-store-release-elect-promotion"]
    - get: p-metric-store-release-elect
      passed: ["p-metric-store-release-elect-promotion"]
      trigger: true
    - get: p-metric-store-release-master
    - get: bumper-tool
    - get: metric-store-ci
  - task: bumper
    file: metric-store-ci/tasks/bumper/task.yml
    input_mapping:
      source: p-metric-store-release-elect
      dest: p-metric-store-release-master
    params:
      SOURCE_BRANCH: release-elect
      DEST_BRANCH: master
      FOLLOW_BUMPS_OF: src/github.com/pivotal/metric-store
      TRACKER_API_TOKEN: ((tracker-key-ci.yml/Notes/tracker_api_token))
  - put: p-metric-store-release-master
    params:
      repository: merged-dest

- name: oss-ms-üö¨
  serial: true
  plan:
  - aggregate:
    - get: metric-store-ci
    - get: cf-deployment-concourse-tasks-image
    - get: denver-locks
    - get: cf-deployment-concourse-tasks
    - get: oss-metric-store-release
      resource: oss-metric-store
      trigger: true
      passed: ["cf-deploy"]
  - task: create-slack-message
    file: metric-store-ci/tasks/alert-message-create/task.yml
    params:
      TITLE: OSS Metric Store Smoke Tests
      TEAM: metric-store-log-cache
  - task: run-msats
    file: metric-store-ci/tasks/run-errand/task.yml
    image: cf-deployment-concourse-tasks-image
    params:
      BBL_STATE_DIR: ((bbl_state_dir))
      DEPLOYMENT_NAME: cf
      ERRAND: metric-store-smoke-tests
      INSTANCE: metric-store/0
      KEEP_ALIVE: true
    input_mapping:
      bbl-state: denver-locks
  on_failure:
    do:
    - put: slack-alert
      params:
        silent: true
        username: ((slack-ci.yml/Notes/slack_alert_username))
        icon_url: ((slack-ci.yml/Notes/slack_alert_icon_url))
        channel: ((slack-ci.yml/Notes/slack_alert_channel))
        attachments_file: metadata/alert_message_failure

- name: oss-metric-store-release-elect-promotion
  serial: true
  plan:
  - aggregate:
    - get: develop
      resource: oss-metric-store
      trigger: true
      passed: ["oss-ms-üö¨", cats]
  - get: oss-metric-store-release-elect
  - put: oss-metric-store-release-elect
    params:
      repository: develop

- name: oss-metric-store-master-promotion
  serial: true
  plan:
  - aggregate:
    - get: hourly-during-the-workday
      trigger: true
    - get: oss-metric-store-release-elect
      passed: ["oss-metric-store-release-elect-promotion"]
      trigger: true
    - get: oss-metric-store-release-master
    - get: bumper-tool
    - get: metric-store-ci
  - task: bumper
    file: metric-store-ci/tasks/bumper/task.yml
    input_mapping:
      source: oss-metric-store-release-elect
      dest: oss-metric-store-release-master
    params:
      SOURCE_BRANCH: release-elect
      DEST_BRANCH: master
      FOLLOW_BUMPS_OF: src/github.com/pivotal/metric-store
      TRACKER_API_TOKEN: ((tracker-key-ci.yml/Notes/tracker_api_token))
  - put: oss-metric-store-release-master
    params:
      repository: merged-dest

- name: build-final-release
  plan:
  - aggregate:
    - get: metric-store-ci
    - get: pcf-observability-ci-image
    - get: p-metric-store-pivnet-metadata
    - get: p-metric-store-release
    - get: p-metric-store-release-master
      passed: [ p-metric-store-master-promotion ]
    - get: oss-metric-store-release-master
      passed: [ oss-metric-store-master-promotion ]
    - get: gcp-light-stemcell
      passed: [ p-metric-store-test-gate ]
    - get: bpm-release
      passed: [ p-metric-store-test-gate ]
    - get: cf-routing-release
      passed: [ p-metric-store-test-gate ]
    - get: loggregator-agent-release
      passed: [ p-metric-store-test-gate ]
  - task: create-slack-message
    file: metric-store-ci/tasks/alert-message-create/task.yml
    params:
      TITLE: Building Final Release
      TEAM: metric-store-log-cache
  - task: create-final-release
    image: pcf-observability-ci-image
    file: metric-store-ci/tasks/create-final-p-metric-store-release/task.yml
    input_mapping:
      pivnet-metadata: p-metric-store-pivnet-metadata
      p-metric-store-release-develop: p-metric-store-release
    params:
      JSON_KEY: ((release-credentials.yml/Notes/gcp-service-account-key))
  - put: p-metric-store-release
    params:
      repository: p-metric-store-release-develop-modified
      rebase: false
  - put: p-metric-store-release-master
    params:
      repository: p-metric-store-release-master-modified
      rebase: false
  - task: github-publish-release-metadata
    file: metric-store-ci/tasks/publish-github-release/task.yml
    input_mapping:
      release-tarball: p-metric-store-final-bosh-release
    params:
      PROJECT_NAME: Metric Store for PCF
  - put: p-metric-store-github-release
    params:
      name: github-release/name
      tag: github-release/tag
      body: github-release/body
      globs:
      - github-release/*.tgz
  - put: oss-metric-store-final-bosh-release
    params:
      file: oss-metric-store-final-bosh-release/release-*.tgz
      content_type: application/octet-stream
  - put: p-metric-store-final-bosh-release
    params:
      file: p-metric-store-final-bosh-release/release-*.tgz
      content_type: application/octet-stream
  on_failure:
    do:
    - put: slack-alert
      params:
        silent: true
        username: ((slack-ci.yml/Notes/slack_alert_username))
        icon_url: ((slack-ci.yml/Notes/slack_alert_icon_url))
        channel: ((slack-ci.yml/Notes/slack_alert_channel))
        attachments_file: metadata/alert_message_failure
  on_success:
    do:
    - put: slack-alert
      params:
        silent: true
        username: ((slack-ci.yml/Notes/slack_alert_username))
        icon_url: ((slack-ci.yml/Notes/slack_alert_icon_url))
        channel: ((slack-ci.yml/Notes/slack_alert_channel))
        attachments_file: metadata/alert_message_success

- name: ü•ñ Bake Final Tile ü•ñ
  plan:
  - aggregate:
    - get: metric-store-ci
    - get: pcf-observability-ci-image
    - get: p-metric-store-pivnet-metadata
      passed: [ build-final-release ]
    - get: p-metric-store-release-master
      passed: [ build-final-release ]
    - get: gcp-light-stemcell
      passed: [ build-final-release ]
    - get: bpm-release
      passed: [ build-final-release ]
    - get: cf-routing-release
      passed: [ build-final-release ]
    - get: loggregator-agent-release
      passed: [ build-final-release ]
    - get: p-metric-store-final-bosh-release
      passed: [ build-final-release ]
    - get: oss-metric-store-final-bosh-release
      passed: [ build-final-release ]
  - task: create-slack-message
    file: metric-store-ci/tasks/alert-message-create/task.yml
    params:
      TITLE: Releasing Final Tile
      TEAM: metric-store-log-cache
  - task: bake-final-tile
    file: metric-store-ci/tasks/tile_bake_final/task.yml
    image: pcf-observability-ci-image
    input_mapping:
      pivnet-metadata: p-metric-store-pivnet-metadata
      stemcell: gcp-light-stemcell
  - put: freshly-baked-final-tiles
    params:
      file: baked-tile/*.pivotal
      content_type: application/octet-stream
  on_failure:
    do:
    - put: slack-alert
      params:
        silent: true
        username: ((slack-ci.yml/Notes/slack_alert_username))
        icon_url: ((slack-ci.yml/Notes/slack_alert_icon_url))
        channel: ((slack-ci.yml/Notes/slack_alert_channel))
        attachments_file: metadata/alert_message_failure
  on_success:
    do:
    - put: slack-alert
      params:
        silent: true
        username: ((slack-ci.yml/Notes/slack_alert_username))
        icon_url: ((slack-ci.yml/Notes/slack_alert_icon_url))
        channel: ((slack-ci.yml/Notes/slack_alert_channel))
        attachments_file: metadata/alert_message_success

- name: üöÄ Push to Pivnet üöÄ
  plan:
  - get: metric-store-ci
  - task: create-slack-message
    file: metric-store-ci/tasks/alert-message-create/task.yml
    params:
      TITLE: Uploading Final Tile to PivNet
      TEAM: metric-store-log-cache
  - get: freshly-baked-final-tiles
    passed:
    - "ü•ñ Bake Final Tile ü•ñ"
  - get: p-metric-store-pivnet-metadata
    passed:
    - "ü•ñ Bake Final Tile ü•ñ"
  - put: p-metric-store-pivnet
    params:
      file_glob: freshly-baked-final-tiles/*.pivotal
      metadata_file: p-metric-store-pivnet-metadata/metadata.yml
      override: false # do not re-upload already uploaded version
  on_failure:
    do:
    - put: slack-alert
      params:
        silent: true
        username: ((slack-ci.yml/Notes/slack_alert_username))
        icon_url: ((slack-ci.yml/Notes/slack_alert_icon_url))
        channel: ((slack-ci.yml/Notes/slack_alert_channel))
        attachments_file: metadata/alert_message_failure
  on_success:
    do:
    - put: slack-alert
      params:
        silent: true
        username: ((slack-ci.yml/Notes/slack_alert_username))
        icon_url: ((slack-ci.yml/Notes/slack_alert_icon_url))
        channel: ((slack-ci.yml/Notes/slack_alert_channel))
        attachments_file: metadata/alert_message_success

- name: log-cache-tools-tests
  serial: true
  plan:
  - aggregate:
    - get: metric-store-ci
    - get: log-cache-tools
      trigger: true
    - get: notification-tools-tests-version
      params: { bump: patch }
  - task: create-slack-message
    file: metric-store-ci/tasks/alert-message-create/task.yml
    input_mapping: { slack-rate-limit-version: notification-tools-tests-version }
    params:
      TITLE: Log Cache Tools Tests
      TEAM: metric-store-log-cache
  - task: run-tests
    file: metric-store-ci/tasks/go-test-module-with-mod/task.yml
    input_mapping:
      source-repo: log-cache-tools
    params:
      GITHUB_PRIVATE_KEY: ((github-key-ci.yml/Notes/ms_github_private_key))
      SUB_FOLDERS: |
        lc-datadog-forwarder
        log-cache-emitter
        ms-datadog-forwarder
  on_failure:
    do:
    - put: notification-tools-tests-version
      params: { file: notification-tools-tests-version/version }
    - task: enable-disable-alert-failure
      file: metric-store-ci/tasks/enable-disable-alert-failure/task.yml
      input_mapping: { slack-rate-limit-version: notification-tools-tests-version }
      params: { alert_multiple: 5 }
    - put: slack-alert
      params:
        silent: true
        username: ((slack-ci.yml/Notes/slack_alert_username))
        icon_url: ((slack-ci.yml/Notes/slack_alert_icon_url))
        channel: ((slack-ci.yml/Notes/slack_alert_channel))
        text_file: modified-metadata/alert_toggle
        attachments_file: modified-metadata/alert_message_failure
  on_success:
    do:
    - task: enable-disable-alert-success
      file: metric-store-ci/tasks/enable-disable-alert-success/task.yml
      input_mapping: { slack-rate-limit-version: notification-tools-tests-version }
    - put: slack-alert
      params:
        silent: true
        username: ((slack-ci.yml/Notes/slack_alert_username))
        icon_url: ((slack-ci.yml/Notes/slack_alert_icon_url))
        channel: ((slack-ci.yml/Notes/slack_alert_channel))
        text_file: modified-metadata/alert_toggle
        attachments_file: modified-metadata/alert_message_success
    - put: notification-tools-tests-version
      params: { bump: minor }
