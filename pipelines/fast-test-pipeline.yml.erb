############## Resource Types ################
resource_types:
- name: gcs-resource
  type: docker-image
  source:
    repository: frodenas/gcs-resource
    tag: v0.5.1

- name: pivnet
  type: docker-image
  source:
    repository: pivotalcf/pivnet-resource
    tag: latest-final

#### Secure Release Pipeline resource type
- name: build-metadata
  type: registry-image
  source:
    repository: pcfopsmanager/build-metadata-resource

############## Resources ################
resources:
- name: metric-store-tile-image
  type: docker-image
  source:
    repository: gcr.io/cf-loggregator-log-cache/metric-store-tile
    username: _json_key
    password: ((gcp_service_account_key))

- name: cf-deployment-concourse-tasks-image
  type: docker-image
  source:
    repository: relintdockerhubpushbot/cf-deployment-concourse-tasks
    tag: latest

#### Secure Release Pipeline resources
- name: srp-helper
  type: registry-image
  source:
    repository: harbor.dhaka.cf-app.com/srp/srp-helper-task
    username: ((srp-helper-harbor-credentials.username))
    password: ((srp-helper-harbor-credentials.password))

- name: build-metadata
  type: build-metadata

- name: metric-store-ci
  type: git
  source:
    uri: git@github.com:cloudfoundry/metric-store-ci
    private_key: ((svcboteos_github_private_key))
    branch: Add-SRP-resource-to-pipeline

- name: pcf-observability-ci-image
  type: docker-image
  source:
    repository: gcr.io/cf-denver/pcf-observability-ci
    username: _json_key
    password: ((gcp_service_account_key))

- name: metric-store-base-image
  type: docker-image
  source:
    repository: gcr.io/cf-loggregator-log-cache/metric-store-ci
    tag: latest
    username: _json_key
    password: ((gcp_service_account_key))

- name: metric-store-develop
  type: git
  source:
    uri: git@github.com:cloudfoundry/metric-store-release
    branch: fast-test-develop
    private_key: ((svcboteos_github_private_key))
    ignore_paths:
    - .final_builds
    - releases
    disable_ci_skip: false
    clean_tags: true

- name: metric-store-dev-release-version
  type: semver
  source:
    driver: gcs
    bucket: metric-store-ci-notifications
    key: test/metric-store-dev-release-version
    initial_version: 0.0.0
    json_key: ((gcp_service_account_key))

- name: metric-store-dev-release
  type: gcs-resource
  source:
    bucket: metric-store-ci-notificationsÂ§
    json_key: ((gcp_service_account_key))
    regexp: test/metric-store-dev-releases/release-(.*).tgz

- name: concourse-tasks
  type: git
  source:
    uri: https://github.com/pivotal-cf/concourse-tasks
    branch: master

- name: golang-release
  type: git
  source:
    uri: git@github.com:bosh-packages/golang-release
    branch: master
    tag_filter: v*
    private_key: ((svcboteos_github_private_key))

- name: metric-store-version
  type: semver
  source:
    driver: gcs
    bucket: metric-store-ci-versions
    key: test/metric-store-release-acceptance-tile
    json_key: ((gcp_service_account_key))
    initial_version: 0.2.0-build.24

- name: dev-tile
  type: gcs-resource
  source:
    bucket: metric-store-ci-notifications
    json_key: ((gcp_service_account_key))
    regexp: test/temp-baked-tiles/(.*).pivotal
    initial_version: 0.2.0-build.24

- name: gcp-light-stemcell
  type: bosh-io-stemcell
  source:
    name: bosh-google-kvm-ubuntu-jammy-go_agent
    version_family: latest
    tarball: true
    preserve_filename: true

- name: bpm-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/bpm-release

- name: cf-routing-release
  type: bosh-io-release
  source:
    repository: cloudfoundry/routing-release
    regexp: .*262.*

############## Jobs ################
jobs:
- name: unit-tests
  serial: true
  plan:
  - in_parallel:
    - get: metric-store-ci
    - get: metric-store-base-image
    - get: metric-store-develop
      trigger: true
  - task: run-tests
    attempts: 3
    image: metric-store-base-image
    config:
      platform: linux
      inputs:
        - name: metric-store-develop
      run:
        path: bash
        args:
          - -c
          - |
            #!/bin/bash
            set -ex
            pushd metric-store-develop
              scripts/test unit
            popd
- name: create-dev-release
  serial: true
  plan:
    - in_parallel:
      - get: metric-store-ci
      - get: metric-store-develop
        trigger: true
      - get: metric-store-dev-release-version
        params: { pre: dev }
      - get: cf-deployment-concourse-tasks-image
      - get: golang-release
    - task: create-dev-release
      file: metric-store-ci/tasks/create-dev-release/task.yml
      image: cf-deployment-concourse-tasks-image
      input_mapping:
        bosh-dev-release-dir: metric-store-develop
        bosh-dev-release-version: metric-store-dev-release-version
      params:
        JSON_KEY: ((gcp_service_account_key))
    - put: metric-store-dev-release
      params:
        file: metric-store-dev-release/release-*.tgz
        content_type: application/octet-stream
    - put: metric-store-dev-release-version
      params: { file: bosh-new-dev-release-version/version }

- name: "Bake-PAS-Tile"
  plan:
    - in_parallel:
      - get: concourse-tasks
      - get: metric-store-ci
      - get: metric-store-develop
        passed: ["create-dev-release"]
      - get: metric-store-dev-release
        trigger: true
        passed: ["create-dev-release"]
      - get: metric-store-version
        params:
          pre: build
      - get: pcf-observability-ci-image
      - get: gcp-light-stemcell
      - get: bpm-release
      - get: cf-routing-release
    - task: "bake tile"
      image: pcf-observability-ci-image
      file: metric-store-ci/tasks/pas_tile_bake/task.yml
      input_mapping:
        metric-store-release: metric-store-develop
        metric-store-dev-release: metric-store-dev-release
        tile-version: metric-store-version
        stemcell: gcp-light-stemcell
    - put: dev-tile
      params:
        file: baked-tile/*.pivotal
        content_type: application/octet-stream
  ensure:
    put: metric-store-version
    params:
      file: new-tile-version/version

##### Secure Release Pipeline jobs
- name: "collect-source-provenance"
  serial: true
  plan:
    - in_parallel:
        - get: srp-helper
        - get: build-metadata
        - get:  metric-store-version
          passed: ["Bake-PAS-Tile"]
        - get: metric-store-develop
          passed: ["Bake-PAS-Tile"]
        - get: metric-store-ci
    - task: "submit-metadata-for-metric-store-release"
      image: srp-helper
      config:
        platform: linux
        inputs:
          - name: metric-store-ci
          - name: metric-store-develop
          - name: build-metadata
          - name: metric-store-version
        params:
          SRP_CLIENT_ID: ((srp-client-credentials.username))
          SRP_CLIENT_SECRET: ((srp-client-credentials.password))
          SRP_URL: https://apigw.vmware.com/v1/s1/api/helix-beta
        run:
          path: /bin/bash
          args:
            - -c
            - |
              set -x
              set -euo pipefail
              mkdir ./provenance

              VERSION=$(cat metric-store-version/version)
              BUILD_NUMBER=$(cat build-metadata/build-name)
              BUILD_PIPELINE_NAME=$(cat build-metadata/build-pipeline-name)
              BUILD_JOB_NAME=$(cat build-metadata/build-job-name)
              BUILD_ID=$(cat build-metadata/build-id)
              COMP_UID="uid.obj.build.concourse(instance='concourse.cf-denver.com',namespace='metric-store-log-cache',pipeline='$BUILD_PIPELINE_NAME',job='$BUILD_JOB_NAME',build_id='$BUILD_ID')"

              srp --version
              srp provenance source \
                --scm-type git \
                --name "metric-store-develop" \
                --path metric-store-develop \
                --saveto ./provenance/source.json \
                --build-number "$BUILD_NUMBER" \
                --version "$VERSION" \
                --all-ephemeral true \
                --build-type release \
                --comp-uid "$COMP_UID"

              srp config auth \
                --client-id $SRP_CLIENT_ID \
                --client-secret $SRP_CLIENT_SECRET \
                --srp-endpoint $SRP_URL \
                --verbose

              srp metadata status \
                --srp-endpoint $SRP_URL

              srp metadata submit \
                -p ./provenance/source.json \
                -u "uid.mtd.provenance_3_0.fragment(obj_uid=$COMP_UID,revision='')" \
                --srp-endpoint $SRP_URL

              srp metadata get \
                --uid "uid.mtd.provenance_3_0.fragment(obj_uid=$COMP_UID,revision='')"

<% envs_we_care_about = {
  "us_3_0": "us_3_0"
} %>
<% envs_we_care_about.each do |env_version, pool_name| %>
- name: "Install-on-PCF-<%= env_version %>"
  plan:
    - in_parallel:
        - get: concourse-tasks
        - get: metric-store-ci
        - get: metric-store-develop
          passed: ["Bake-PAS-Tile"]
        - get: metric-store-dev-release
          passed: ["Bake-PAS-Tile"]
        - get: pcf-observability-ci-image
        - get: metric-store-tile-image
        - get: metric-store-version
          passed: ["Bake-PAS-Tile"]
        - get: dev-tile
          trigger: true
          passed: ["Bake-PAS-Tile"]
        - get: gcp-light-stemcell
          passed: ["Bake-PAS-Tile"]
    - task: "Claim Smith Env"
      attempts: 3
      image: metric-store-tile-image
      config:
        platform: linux
        outputs:
          - name: environment
        run:
          path: sh
          args:
            - "-c"
            - |
              set -eu
              # exports smith environment name to `env`
              $(smith claim -p <%= pool_name %> -n "cf-metric-store CI" | tail -1)
              echo "Claimed smith environment: ${env}"
              echo ${env} > environment/name
              smith read > environment/metadata
      on_failure:
        task: release-env
        image: metric-store-tile-image
        config:
          platform: linux
          run:
            path: sh
            args:
              - "-c"
              - |
                set -e
                sleep 10
      params:
        TOOLSMITHS_API_TOKEN: ((smith_token))
    - task: "Upload and Config"
      input_mapping:
        tile-version: metric-store-version
        baked-tile: dev-tile
      image: pcf-observability-ci-image
      file: metric-store-ci/tasks/tile_install/task-prep.yml
    - task: "Apply Changes CF"
      attempts: 3
      image: pcf-observability-ci-image
      file: metric-store-ci/tasks/tile_install/task-apply-cf.yml
    - task: "Apply Changes Metric Store"
      image: pcf-observability-ci-image
      file: metric-store-ci/tasks/tile_install/task-apply-ms.yml

<% end %>
